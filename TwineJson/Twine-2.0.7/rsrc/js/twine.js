function EventedLocalStorage(t,e){return Backbone.LocalStorage.call(this,t,e)}!function(t){"function"==typeof define&&define.amd?define(["jquery"],t(jQuery)):t(jQuery)}(function(t){"use strict";return t.fn.extend({omniWindow:function(e){e=t.extend(!0,{animationsPriority:{show:["overlay","modal"],hide:["modal","overlay"]},overlay:{selector:".ow-overlay",hideClass:"ow-closed",animations:{show:function(t,e){return e(t)},hide:function(t,e){return e(t)},internal:{show:function(t){t.overlay.removeClass(e.overlay.hideClass)},hide:function(t){t.overlay.addClass(e.overlay.hideClass)}}}},modal:{hideClass:"ow-closed",animations:{show:function(t,e){return e(t)},hide:function(t,e){return e(t)},internal:{show:function(t){t.modal.removeClass(e.modal.hideClass)},hide:function(t){t.modal.addClass(e.modal.hideClass)}}},internal:{stateAttribute:"ow-active"}},eventsNames:{show:"show.ow",hide:"hide.ow",internal:{overlayClick:"click.ow",keyboardKeyUp:"keyup.ow"}},callbacks:{beforeShow:function(t,e){return e(t)},positioning:function(t,e){return e(t)},afterShow:function(t,e){return e(t)},beforeHide:function(t,e){return e(t)},afterHide:function(t,e){return e(t)},internal:{beforeShow:function(t){return t.modal.data(e.modal.internal.stateAttribute)?!1:(t.modal.data(e.modal.internal.stateAttribute,!0),!0)},afterShow:function(i){t(document).on(e.eventsNames.internal.keyboardKeyUp,function(t){27===t.keyCode&&i.modal.trigger(e.eventsNames.hide)}),i.overlay.on(e.eventsNames.internal.overlayClick,function(){i.modal.trigger(e.eventsNames.hide)})},positioning:function(t){t.modal.css("margin-left",Math.round(t.modal.outerWidth()/-2))},beforeHide:function(t){return t.modal.data(e.modal.internal.stateAttribute)?(t.modal.data(e.modal.internal.stateAttribute,!1),!0):!1},afterHide:function(i){i.overlay.off(e.eventsNames.internal.overlayClick),t(document).off(e.eventsNames.internal.keyboardKeyUp),i.overlay.css("display",""),i.modal.css("display","")}}}},e);var i=function(t,i,n){var a=e.animationsPriority[t][0],s=e.animationsPriority[t][1];e[a].animations[t](i,function(o){e[a].animations.internal[t](o),e[s].animations[t](i,function(a){e[s].animations.internal[t](a),e.callbacks[n](i,e.callbacks.internal[n])})})},n=function(t){e.callbacks.beforeShow(t,e.callbacks.internal.beforeShow)&&(e.callbacks.positioning(t,e.callbacks.internal.positioning),i("show",t,"afterShow"))},a=function(t){e.callbacks.beforeHide(t,e.callbacks.internal.beforeHide)&&i("hide",t,"afterHide")},s=t(e.overlay.selector);return this.each(function(){var i=t(this),o={modal:i,overlay:s};i.bind(e.eventsNames.show,function(){n(o)}).bind(e.eventsNames.hide,function(){a(o)})})}}),t}),function(t){"use strict";if(t.URL=t.URL||t.webkitURL,t.Blob&&t.URL)try{return void new Blob}catch(e){}var i=t.BlobBuilder||t.WebKitBlobBuilder||t.MozBlobBuilder||function(t){var e=function(t){return Object.prototype.toString.call(t).match(/^\[object\s(.*)\]$/)[1]},i=function(){this.data=[]},n=function(t,e,i){this.data=t,this.size=t.length,this.type=e,this.encoding=i},a=i.prototype,s=n.prototype,o=t.FileReaderSync,r=function(t){this.code=this[this.name=t]},l="NOT_FOUND_ERR SECURITY_ERR ABORT_ERR NOT_READABLE_ERR ENCODING_ERR NO_MODIFICATION_ALLOWED_ERR INVALID_STATE_ERR SYNTAX_ERR".split(" "),c=l.length,h=t.URL||t.webkitURL||t,d=h.createObjectURL,u=h.revokeObjectURL,p=h,f=t.btoa,m=t.atob,g=t.ArrayBuffer,w=t.Uint8Array,y=/^[\w-]+:\/*\[?[\w\.:-]+\]?(?::[0-9]+)?/;for(n.fake=s.fake=!0;c--;)r.prototype[l[c]]=c+1;return h.createObjectURL||(p=t.URL=function(t){var e,i=document.createElementNS("http://www.w3.org/1999/xhtml","a");return i.href=t,"origin"in i||("data:"===i.protocol.toLowerCase()?i.origin=null:(e=t.match(y),i.origin=e&&e[1])),i}),p.createObjectURL=function(t){var e,i=t.type;return null===i&&(i="application/octet-stream"),t instanceof n?(e="data:"+i,"base64"===t.encoding?e+";base64,"+t.data:"URI"===t.encoding?e+","+decodeURIComponent(t.data):f?e+";base64,"+f(t.data):e+","+encodeURIComponent(t.data)):d?d.call(h,t):void 0},p.revokeObjectURL=function(t){"data:"!==t.substring(0,5)&&u&&u.call(h,t)},a.append=function(t){var i=this.data;if(w&&(t instanceof g||t instanceof w)){for(var a="",s=new w(t),l=0,c=s.length;c>l;l++)a+=String.fromCharCode(s[l]);i.push(a)}else if("Blob"===e(t)||"File"===e(t)){if(!o)throw new r("NOT_READABLE_ERR");var h=new o;i.push(h.readAsBinaryString(t))}else t instanceof n?"base64"===t.encoding&&m?i.push(m(t.data)):"URI"===t.encoding?i.push(decodeURIComponent(t.data)):"raw"===t.encoding&&i.push(t.data):("string"!=typeof t&&(t+=""),i.push(unescape(encodeURIComponent(t))))},a.getBlob=function(t){return arguments.length||(t=null),new n(this.data.join(""),t,"raw")},a.toString=function(){return"[object BlobBuilder]"},s.slice=function(t,e,i){var a=arguments.length;return 3>a&&(i=null),new n(this.data.slice(t,a>1?e:this.data.length),i,this.encoding)},s.toString=function(){return"[object Blob]"},s.close=function(){this.size=0,delete this.data},i}(t);t.Blob=function(t,e){var n=e?e.type||"":"",a=new i;if(t)for(var s=0,o=t.length;o>s;s++)a.append(t[s]);return a.getBlob(n)}}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this.content||this);var saveAs=saveAs||"undefined"!=typeof navigator&&navigator.msSaveOrOpenBlob&&navigator.msSaveOrOpenBlob.bind(navigator)||function(t){"use strict";if("undefined"==typeof navigator||!/MSIE [1-9]\./.test(navigator.userAgent)){var e=t.document,i=function(){return t.URL||t.webkitURL||t},n=e.createElementNS("http://www.w3.org/1999/xhtml","a"),a="download"in n,s=function(i){var n=e.createEvent("MouseEvents");n.initMouseEvent("click",!0,!1,t,0,0,0,0,0,!1,!1,!1,!1,0,null),i.dispatchEvent(n)},o=t.webkitRequestFileSystem,r=t.requestFileSystem||o||t.mozRequestFileSystem,l=function(e){(t.setImmediate||t.setTimeout)(function(){throw e},0)},c="application/octet-stream",h=0,d=500,u=function(e){var n=function(){"string"==typeof e?i().revokeObjectURL(e):e.remove()};t.chrome?n():setTimeout(n,d)},p=function(t,e,i){e=[].concat(e);for(var n=e.length;n--;){var a=t["on"+e[n]];if("function"==typeof a)try{a.call(t,i||t)}catch(s){l(s)}}},f=function(e,l){var d,f,m,g=this,w=e.type,y=!1,v=function(){p(g,"writestart progress write writeend".split(" "))},b=function(){if((y||!d)&&(d=i().createObjectURL(e)),f)f.location.href=d;else{var n=t.open(d,"_blank");void 0==n&&"undefined"!=typeof safari&&(t.location.href=d)}g.readyState=g.DONE,v(),u(d)},S=function(t){return function(){return g.readyState!==g.DONE?t.apply(this,arguments):void 0}},$={create:!0,exclusive:!1};return g.readyState=g.INIT,l||(l="download"),a?(d=i().createObjectURL(e),n.href=d,n.download=l,s(n),g.readyState=g.DONE,v(),void u(d)):(t.chrome&&w&&w!==c&&(m=e.slice||e.webkitSlice,e=m.call(e,0,e.size,c),y=!0),o&&"download"!==l&&(l+=".download"),(w===c||o)&&(f=t),r?(h+=e.size,void r(t.TEMPORARY,h,S(function(t){t.root.getDirectory("saved",$,S(function(t){var i=function(){t.getFile(l,$,S(function(t){t.createWriter(S(function(i){i.onwriteend=function(e){f.location.href=t.toURL(),g.readyState=g.DONE,p(g,"writeend",e),u(t)},i.onerror=function(){var t=i.error;t.code!==t.ABORT_ERR&&b()},"writestart progress write abort".split(" ").forEach(function(t){i["on"+t]=g["on"+t]}),i.write(e),g.abort=function(){i.abort(),g.readyState=g.DONE},g.readyState=g.WRITING}),b)}),b)};t.getFile(l,{create:!1},S(function(t){t.remove(),i()}),S(function(t){t.code===t.NOT_FOUND_ERR?i():b()}))}),b)}),b)):void b())},m=f.prototype,g=function(t,e){return new f(t,e)};return m.abort=function(){var t=this;t.readyState=t.DONE,p(t,"abort")},m.readyState=m.INIT=0,m.WRITING=1,m.DONE=2,m.error=m.onwritestart=m.onprogress=m.onwrite=m.onabort=m.onerror=m.onwriteend=null,g}}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this.content);"undefined"!=typeof module&&module.exports?module.exports.saveAs=saveAs:"undefined"!=typeof define&&null!==define&&null!=define.amd&&define([],function(){return saveAs}),function(t,e){function i(t){return d.PF.compile(t||"nplurals=2; plural=(n != 1);")}function n(t,e){this._key=t,this._i18n=e}var a=Array.prototype,s=Object.prototype,o=a.slice,r=s.hasOwnProperty,l=a.forEach,c={},h={forEach:function(t,e,i){var n,a,s;if(null!==t)if(l&&t.forEach===l)t.forEach(e,i);else if(t.length===+t.length){for(n=0,a=t.length;a>n;n++)if(n in t&&e.call(i,t[n],n,t)===c)return}else for(s in t)if(r.call(t,s)&&e.call(i,t[s],s,t)===c)return},extend:function(t){return this.forEach(o.call(arguments,1),function(e){for(var i in e)t[i]=e[i]}),t}},d=function(t){if(this.defaults={locale_data:{messages:{"":{domain:"messages",lang:"en",plural_forms:"nplurals=2; plural=(n != 1);"}}},domain:"messages",debug:!1},this.options=h.extend({},this.defaults,t),this.textdomain(this.options.domain),t.domain&&!this.options.locale_data[this.options.domain])throw new Error("Text domain set to non-existent domain: `"+t.domain+"`")};d.context_delimiter=String.fromCharCode(4),h.extend(n.prototype,{onDomain:function(t){return this._domain=t,this},withContext:function(t){return this._context=t,this},ifPlural:function(t,e){return this._val=t,this._pkey=e,this},fetch:function(t){return"[object Array]"!={}.toString.call(t)&&(t=[].slice.call(arguments,0)),(t&&t.length?d.sprintf:function(t){return t})(this._i18n.dcnpgettext(this._domain,this._context,this._key,this._pkey,this._val),t)}}),h.extend(d.prototype,{translate:function(t){return new n(t,this)},textdomain:function(t){return t?void(this._textdomain=t):this._textdomain},gettext:function(t){return this.dcnpgettext.call(this,e,e,t)},dgettext:function(t,i){return this.dcnpgettext.call(this,t,e,i)},dcgettext:function(t,i){return this.dcnpgettext.call(this,t,e,i)},ngettext:function(t,i,n){return this.dcnpgettext.call(this,e,e,t,i,n)},dngettext:function(t,i,n,a){return this.dcnpgettext.call(this,t,e,i,n,a)},dcngettext:function(t,i,n,a){return this.dcnpgettext.call(this,t,e,i,n,a)},pgettext:function(t,i){return this.dcnpgettext.call(this,e,t,i)},dpgettext:function(t,e,i){return this.dcnpgettext.call(this,t,e,i)},dcpgettext:function(t,e,i){return this.dcnpgettext.call(this,t,e,i)},npgettext:function(t,i,n,a){return this.dcnpgettext.call(this,e,t,i,n,a)},dnpgettext:function(t,e,i,n,a){return this.dcnpgettext.call(this,t,e,i,n,a)},dcnpgettext:function(t,e,n,a,s){a=a||n,t=t||this._textdomain;var o;if(!this.options)return o=new d,o.dcnpgettext.call(o,void 0,void 0,n,a,s);if(!this.options.locale_data)throw new Error("No locale data provided.");if(!this.options.locale_data[t])throw new Error("Domain `"+t+"` was not found.");if(!this.options.locale_data[t][""])throw new Error("No locale meta information provided.");if(!n)throw new Error("No translation key found.");var r,l,c,h=e?e+d.context_delimiter+n:n,u=this.options.locale_data,p=u[t],f=(u.messages||this.defaults.locale_data.messages)[""],m=p[""].plural_forms||p[""]["Plural-Forms"]||p[""]["plural-forms"]||f.plural_forms||f["Plural-Forms"]||f["plural-forms"];if(void 0===s)c=0;else{if("number"!=typeof s&&(s=parseInt(s,10),isNaN(s)))throw new Error("The number that was passed in is not a number.");c=i(m)(s)}if(!p)throw new Error("No domain named `"+t+"` could be found.");return r=p[h],!r||c>r.length?(this.options.missing_key_callback&&this.options.missing_key_callback(h,t),l=[n,a],this.options.debug===!0&&console.log(l[i(m)(s)]),l[i()(s)]):(l=r[c],l?l:(l=[n,a],l[i()(s)]))}});var u=function(){function t(t){return Object.prototype.toString.call(t).slice(8,-1).toLowerCase()}function e(t,e){for(var i=[];e>0;i[--e]=t);return i.join("")}var i=function(){return i.cache.hasOwnProperty(arguments[0])||(i.cache[arguments[0]]=i.parse(arguments[0])),i.format.call(null,i.cache[arguments[0]],arguments)};return i.format=function(i,n){var a,s,o,r,l,c,h,d=1,p=i.length,f="",m=[];for(s=0;p>s;s++)if(f=t(i[s]),"string"===f)m.push(i[s]);else if("array"===f){if(r=i[s],r[2])for(a=n[d],o=0;o<r[2].length;o++){if(!a.hasOwnProperty(r[2][o]))throw u('[sprintf] property "%s" does not exist',r[2][o]);a=a[r[2][o]]}else a=r[1]?n[r[1]]:n[d++];if(/[^s]/.test(r[8])&&"number"!=t(a))throw u("[sprintf] expecting number but found %s",t(a));switch(("undefined"==typeof a||null===a)&&(a=""),r[8]){case"b":a=a.toString(2);break;case"c":a=String.fromCharCode(a);break;case"d":a=parseInt(a,10);break;case"e":a=r[7]?a.toExponential(r[7]):a.toExponential();break;case"f":a=r[7]?parseFloat(a).toFixed(r[7]):parseFloat(a);break;case"o":a=a.toString(8);break;case"s":a=(a=String(a))&&r[7]?a.substring(0,r[7]):a;break;case"u":a=Math.abs(a);break;case"x":a=a.toString(16);break;case"X":a=a.toString(16).toUpperCase()}a=/[def]/.test(r[8])&&r[3]&&a>=0?"+"+a:a,c=r[4]?"0"==r[4]?"0":r[4].charAt(1):" ",h=r[6]-String(a).length,l=r[6]?e(c,h):"",m.push(r[5]?a+l:l+a)}return m.join("")},i.cache={},i.parse=function(t){for(var e=t,i=[],n=[],a=0;e;){if(null!==(i=/^[^\x25]+/.exec(e)))n.push(i[0]);else if(null!==(i=/^\x25{2}/.exec(e)))n.push("%");else{if(null===(i=/^\x25(?:([1-9]\d*)\$|\(([^\)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([b-fosuxX])/.exec(e)))throw"[sprintf] huh?";if(i[2]){a|=1;var s=[],o=i[2],r=[];if(null===(r=/^([a-z_][a-z_\d]*)/i.exec(o)))throw"[sprintf] huh?";for(s.push(r[1]);""!==(o=o.substring(r[0].length));)if(null!==(r=/^\.([a-z_][a-z_\d]*)/i.exec(o)))s.push(r[1]);else{if(null===(r=/^\[(\d+)\]/.exec(o)))throw"[sprintf] huh?";s.push(r[1])}i[2]=s}else a|=2;if(3===a)throw"[sprintf] mixing positional and named placeholders is not (yet) supported";n.push(i)}e=e.substring(i[0].length)}return n},i}(),p=function(t,e){return e.unshift(t),u.apply(null,e)};d.parse_plural=function(t,e){return t=t.replace(/n/g,e),d.parse_expression(t)},d.sprintf=function(t,e){return"[object Array]"=={}.toString.call(e)?p(t,[].slice.call(e)):u.apply(this,[].slice.call(arguments))},d.prototype.sprintf=function(){return d.sprintf.apply(this,arguments)},d.PF={},d.PF.parse=function(t){var e=d.PF.extractPluralExpr(t);return d.PF.parser.parse.call(d.PF.parser,e)},d.PF.compile=function(t){function e(t){return t===!0?1:t?t:0}var i=d.PF.parse(t);return function(t){return e(d.PF.interpreter(i)(t))}},d.PF.interpreter=function(t){return function(e){switch(t.type){case"GROUP":return d.PF.interpreter(t.expr)(e);case"TERNARY":return d.PF.interpreter(t.expr)(e)?d.PF.interpreter(t.truthy)(e):d.PF.interpreter(t.falsey)(e);case"OR":return d.PF.interpreter(t.left)(e)||d.PF.interpreter(t.right)(e);case"AND":return d.PF.interpreter(t.left)(e)&&d.PF.interpreter(t.right)(e);case"LT":return d.PF.interpreter(t.left)(e)<d.PF.interpreter(t.right)(e);case"GT":return d.PF.interpreter(t.left)(e)>d.PF.interpreter(t.right)(e);case"LTE":return d.PF.interpreter(t.left)(e)<=d.PF.interpreter(t.right)(e);case"GTE":return d.PF.interpreter(t.left)(e)>=d.PF.interpreter(t.right)(e);case"EQ":return d.PF.interpreter(t.left)(e)==d.PF.interpreter(t.right)(e);case"NEQ":return d.PF.interpreter(t.left)(e)!=d.PF.interpreter(t.right)(e);case"MOD":return d.PF.interpreter(t.left)(e)%d.PF.interpreter(t.right)(e);case"VAR":return e;case"NUM":return t.val;default:throw new Error("Invalid Token found.")}}},d.PF.extractPluralExpr=function(t){t=t.replace(/^\s\s*/,"").replace(/\s\s*$/,""),/;\s*$/.test(t)||(t=t.concat(";"));var e,i=/nplurals\=(\d+);/,n=/plural\=(.*);/,a=t.match(i),s={};if(!(a.length>1))throw new Error("nplurals not found in plural_forms string: "+t);if(s.nplurals=a[1],t=t.replace(i,""),e=t.match(n),!(e&&e.length>1))throw new Error("`plural` expression not found: "+t);return e[1]},d.PF.parser=function(){var t={trace:function(){},yy:{},symbols_:{error:2,expressions:3,e:4,EOF:5,"?":6,":":7,"||":8,"&&":9,"<":10,"<=":11,">":12,">=":13,"!=":14,"==":15,"%":16,"(":17,")":18,n:19,NUMBER:20,$accept:0,$end:1},terminals_:{2:"error",5:"EOF",6:"?",7:":",8:"||",9:"&&",10:"<",11:"<=",12:">",13:">=",14:"!=",15:"==",16:"%",17:"(",18:")",19:"n",20:"NUMBER"},productions_:[0,[3,2],[4,5],[4,3],[4,3],[4,3],[4,3],[4,3],[4,3],[4,3],[4,3],[4,3],[4,3],[4,1],[4,1]],performAction:function(t,e,i,n,a,s,o){var r=s.length-1;switch(a){case 1:return{type:"GROUP",expr:s[r-1]};case 2:this.$={type:"TERNARY",expr:s[r-4],truthy:s[r-2],falsey:s[r]};break;case 3:this.$={type:"OR",left:s[r-2],right:s[r]};break;case 4:this.$={type:"AND",left:s[r-2],right:s[r]};break;case 5:this.$={type:"LT",left:s[r-2],right:s[r]};break;case 6:this.$={type:"LTE",left:s[r-2],right:s[r]};break;case 7:this.$={type:"GT",left:s[r-2],right:s[r]};break;case 8:this.$={type:"GTE",left:s[r-2],right:s[r]};break;case 9:this.$={type:"NEQ",left:s[r-2],right:s[r]};break;case 10:this.$={type:"EQ",left:s[r-2],right:s[r]};break;case 11:this.$={type:"MOD",left:s[r-2],right:s[r]};break;case 12:this.$={type:"GROUP",expr:s[r-1]};break;case 13:this.$={type:"VAR"};break;case 14:this.$={type:"NUM",val:Number(t)}}},table:[{3:1,4:2,17:[1,3],19:[1,4],20:[1,5]},{1:[3]},{5:[1,6],6:[1,7],8:[1,8],9:[1,9],10:[1,10],11:[1,11],12:[1,12],13:[1,13],14:[1,14],15:[1,15],16:[1,16]},{4:17,17:[1,3],19:[1,4],20:[1,5]},{5:[2,13],6:[2,13],7:[2,13],8:[2,13],9:[2,13],10:[2,13],11:[2,13],12:[2,13],13:[2,13],14:[2,13],15:[2,13],16:[2,13],18:[2,13]},{5:[2,14],6:[2,14],7:[2,14],8:[2,14],9:[2,14],10:[2,14],11:[2,14],12:[2,14],13:[2,14],14:[2,14],15:[2,14],16:[2,14],18:[2,14]},{1:[2,1]},{4:18,17:[1,3],19:[1,4],20:[1,5]},{4:19,17:[1,3],19:[1,4],20:[1,5]},{4:20,17:[1,3],19:[1,4],20:[1,5]},{4:21,17:[1,3],19:[1,4],20:[1,5]},{4:22,17:[1,3],19:[1,4],20:[1,5]},{4:23,17:[1,3],19:[1,4],20:[1,5]},{4:24,17:[1,3],19:[1,4],20:[1,5]},{4:25,17:[1,3],19:[1,4],20:[1,5]},{4:26,17:[1,3],19:[1,4],20:[1,5]},{4:27,17:[1,3],19:[1,4],20:[1,5]},{6:[1,7],8:[1,8],9:[1,9],10:[1,10],11:[1,11],12:[1,12],13:[1,13],14:[1,14],15:[1,15],16:[1,16],18:[1,28]},{6:[1,7],7:[1,29],8:[1,8],9:[1,9],10:[1,10],11:[1,11],12:[1,12],13:[1,13],14:[1,14],15:[1,15],16:[1,16]},{5:[2,3],6:[2,3],7:[2,3],8:[2,3],9:[1,9],10:[1,10],11:[1,11],12:[1,12],13:[1,13],14:[1,14],15:[1,15],16:[1,16],18:[2,3]},{5:[2,4],6:[2,4],7:[2,4],8:[2,4],9:[2,4],10:[1,10],11:[1,11],12:[1,12],13:[1,13],14:[1,14],15:[1,15],16:[1,16],18:[2,4]},{5:[2,5],6:[2,5],7:[2,5],8:[2,5],9:[2,5],10:[2,5],11:[2,5],12:[2,5],13:[2,5],14:[2,5],15:[2,5],16:[1,16],18:[2,5]},{5:[2,6],6:[2,6],7:[2,6],8:[2,6],9:[2,6],10:[2,6],11:[2,6],12:[2,6],13:[2,6],14:[2,6],15:[2,6],16:[1,16],18:[2,6]},{5:[2,7],6:[2,7],7:[2,7],8:[2,7],9:[2,7],10:[2,7],11:[2,7],12:[2,7],13:[2,7],14:[2,7],15:[2,7],16:[1,16],18:[2,7]},{5:[2,8],6:[2,8],7:[2,8],8:[2,8],9:[2,8],10:[2,8],11:[2,8],12:[2,8],13:[2,8],14:[2,8],15:[2,8],16:[1,16],18:[2,8]},{5:[2,9],6:[2,9],7:[2,9],8:[2,9],9:[2,9],10:[2,9],11:[2,9],12:[2,9],13:[2,9],14:[2,9],15:[2,9],16:[1,16],18:[2,9]},{5:[2,10],6:[2,10],7:[2,10],8:[2,10],9:[2,10],10:[2,10],11:[2,10],12:[2,10],13:[2,10],14:[2,10],15:[2,10],16:[1,16],18:[2,10]},{5:[2,11],6:[2,11],7:[2,11],8:[2,11],9:[2,11],10:[2,11],11:[2,11],12:[2,11],13:[2,11],14:[2,11],15:[2,11],16:[2,11],18:[2,11]},{5:[2,12],6:[2,12],7:[2,12],8:[2,12],9:[2,12],10:[2,12],11:[2,12],12:[2,12],13:[2,12],14:[2,12],15:[2,12],16:[2,12],18:[2,12]},{4:30,17:[1,3],19:[1,4],20:[1,5]},{5:[2,2],6:[1,7],7:[2,2],8:[1,8],9:[1,9],10:[1,10],11:[1,11],12:[1,12],13:[1,13],14:[1,14],15:[1,15],16:[1,16],18:[2,2]}],defaultActions:{6:[2,1]},parseError:function(t,e){throw new Error(t)},parse:function(t){function e(t){a.length=a.length-2*t,s.length=s.length-t,o.length=o.length-t}function i(){var t;return t=n.lexer.lex()||1,"number"!=typeof t&&(t=n.symbols_[t]||t),t}var n=this,a=[0],s=[null],o=[],r=this.table,l="",c=0,h=0,d=0,u=2,p=1;this.lexer.setInput(t),this.lexer.yy=this.yy,this.yy.lexer=this.lexer,"undefined"==typeof this.lexer.yylloc&&(this.lexer.yylloc={});var f=this.lexer.yylloc;o.push(f),"function"==typeof this.yy.parseError&&(this.parseError=this.yy.parseError);for(var m,g,w,y,v,b,S,$,k,x={};;){if(w=a[a.length-1],this.defaultActions[w]?y=this.defaultActions[w]:(null==m&&(m=i()),y=r[w]&&r[w][m]),"undefined"==typeof y||!y.length||!y[0]){if(!d){k=[];for(b in r[w])this.terminals_[b]&&b>2&&k.push("'"+this.terminals_[b]+"'");var C="";C=this.lexer.showPosition?"Parse error on line "+(c+1)+":\n"+this.lexer.showPosition()+"\nExpecting "+k.join(", ")+", got '"+this.terminals_[m]+"'":"Parse error on line "+(c+1)+": Unexpected "+(1==m?"end of input":"'"+(this.terminals_[m]||m)+"'"),this.parseError(C,{text:this.lexer.match,token:this.terminals_[m]||m,line:this.lexer.yylineno,loc:f,expected:k})}if(3==d){if(m==p)throw new Error(C||"Parsing halted.");h=this.lexer.yyleng,l=this.lexer.yytext,c=this.lexer.yylineno,f=this.lexer.yylloc,m=i()}for(;;){if(u.toString()in r[w])break;if(0==w)throw new Error(C||"Parsing halted.");e(1),w=a[a.length-1]}g=m,m=u,w=a[a.length-1],y=r[w]&&r[w][u],d=3}if(y[0]instanceof Array&&y.length>1)throw new Error("Parse Error: multiple actions possible at state: "+w+", token: "+m);switch(y[0]){case 1:a.push(m),s.push(this.lexer.yytext),o.push(this.lexer.yylloc),a.push(y[1]),m=null,g?(m=g,g=null):(h=this.lexer.yyleng,l=this.lexer.yytext,c=this.lexer.yylineno,f=this.lexer.yylloc,d>0&&d--);break;case 2:if(S=this.productions_[y[1]][1],x.$=s[s.length-S],x._$={first_line:o[o.length-(S||1)].first_line,last_line:o[o.length-1].last_line,first_column:o[o.length-(S||1)].first_column,last_column:o[o.length-1].last_column},v=this.performAction.call(x,l,h,c,this.yy,y[1],s,o),"undefined"!=typeof v)return v;S&&(a=a.slice(0,-1*S*2),s=s.slice(0,-1*S),o=o.slice(0,-1*S)),a.push(this.productions_[y[1]][0]),s.push(x.$),o.push(x._$),$=r[a[a.length-2]][a[a.length-1]],a.push($);break;case 3:return!0}}return!0}},e=function(){var t={EOF:1,parseError:function(t,e){if(!this.yy.parseError)throw new Error(t);this.yy.parseError(t,e)},setInput:function(t){return this._input=t,this._more=this._less=this.done=!1,this.yylineno=this.yyleng=0,this.yytext=this.matched=this.match="",this.conditionStack=["INITIAL"],this.yylloc={first_line:1,first_column:0,last_line:1,last_column:0},this},input:function(){var t=this._input[0];this.yytext+=t,this.yyleng++,this.match+=t,this.matched+=t;var e=t.match(/\n/);return e&&this.yylineno++,this._input=this._input.slice(1),t},unput:function(t){return this._input=t+this._input,this},more:function(){return this._more=!0,this},pastInput:function(){var t=this.matched.substr(0,this.matched.length-this.match.length);return(t.length>20?"...":"")+t.substr(-20).replace(/\n/g,"")},upcomingInput:function(){var t=this.match;return t.length<20&&(t+=this._input.substr(0,20-t.length)),(t.substr(0,20)+(t.length>20?"...":"")).replace(/\n/g,"")},showPosition:function(){var t=this.pastInput(),e=new Array(t.length+1).join("-");return t+this.upcomingInput()+"\n"+e+"^"},next:function(){if(this.done)return this.EOF;this._input||(this.done=!0);var t,e,i;this._more||(this.yytext="",this.match="");for(var n=this._currentRules(),a=0;a<n.length;a++)if(e=this._input.match(this.rules[n[a]]))return i=e[0].match(/\n.*/g),i&&(this.yylineno+=i.length),this.yylloc={first_line:this.yylloc.last_line,last_line:this.yylineno+1,first_column:this.yylloc.last_column,last_column:i?i[i.length-1].length-1:this.yylloc.last_column+e[0].length},this.yytext+=e[0],this.match+=e[0],this.matches=e,this.yyleng=this.yytext.length,this._more=!1,this._input=this._input.slice(e[0].length),this.matched+=e[0],t=this.performAction.call(this,this.yy,this,n[a],this.conditionStack[this.conditionStack.length-1]),t?t:void 0;return""===this._input?this.EOF:void this.parseError("Lexical error on line "+(this.yylineno+1)+". Unrecognized text.\n"+this.showPosition(),{text:"",token:null,line:this.yylineno})},lex:function(){var t=this.next();return"undefined"!=typeof t?t:this.lex()},begin:function(t){this.conditionStack.push(t)},popState:function(){return this.conditionStack.pop()},_currentRules:function(){return this.conditions[this.conditionStack[this.conditionStack.length-1]].rules},topState:function(){return this.conditionStack[this.conditionStack.length-2]},pushState:function(t){this.begin(t)}};return t.performAction=function(t,e,i,n){switch(i){case 0:break;case 1:return 20;case 2:return 19;case 3:return 8;case 4:return 9;case 5:return 6;case 6:return 7;case 7:return 11;case 8:return 13;case 9:return 10;case 10:return 12;case 11:return 14;case 12:return 15;case 13:return 16;case 14:return 17;case 15:return 18;case 16:return 5;case 17:return"INVALID"}},t.rules=[/^\s+/,/^[0-9]+(\.[0-9]+)?\b/,/^n\b/,/^\|\|/,/^&&/,/^\?/,/^:/,/^<=/,/^>=/,/^</,/^>/,/^!=/,/^==/,/^%/,/^\(/,/^\)/,/^$/,/^./],t.conditions={INITIAL:{rules:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17],inclusive:!0}},t}();return t.lexer=e,t}(),"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=d),exports.Jed=d):("function"==typeof define&&define.amd&&define(function(){return d}),t.Jed=d)}(this);var UUID=function t(e){return e?(e^16*Math.random()>>e/4).toString(16):([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,t)},ui={initBody:function(){if(!$("body").data("uiInited")){var t=$("body");if(t.data("uiInited",!0),ui.fastclick=FastClick.attach(document.body),navigator.userAgent.match(/iPhone|iPad|iPod/i)&&t.addClass("iOS"),-1!=navigator.userAgent.indexOf("Safari")&&-1==navigator.userAgent.indexOf("Chrome")&&t.addClass("safari"),t.on("keydown.twineui keyup.twineui",".modal",function(t){27!=t.keyCode&&t.stopPropagation()}),0==$("#modalOverlay").length){var e=$('<div id="modalOverlay" class="hide"></div>');e.on("mousedown, mouseup",function(t){t.stopPropagation()}),t.append(e)}0==$("#notifications").length&&t.append('<div id="notifications"></div>'),t.on("webkitAnimationEnd.twineui oanimationend.twineui msAnimationEnd.twineui",function(t){t.type="animationend",$(t.target).trigger(t)}),t.on("click.twineui","[data-modal-show]",function(t){$($(this).data("modal-show")).data("modal").trigger("show"),t.preventDefault()}),t.on("click.twineui","[data-modal-hide]",function(t){var e=$(this).data("modal-hide");"this"==e?$(this).closest(".modal").data("modal").trigger("hide"):$(e).data("modal").trigger("hide")}),$.fn.bubble=function(t){var e=$(this),i=e.closest(".bubbleContainer"),n=i.find(".bubble");switch(t){case"show":if(i.hasClass("active"))return this;$(".active[data-bubble]").bubble("hide"),e.attr("title")&&e.powerTip("hide"),e.addClass("active"),i.addClass("active"),n.css({display:"block",height:n.height()}).addClass("fadeIn fast"),n.trigger("bubbleshow");break;case"hide":if(!i.hasClass("active"))return this;i.find('button[data-bubble="toggle"]').removeClass("active"),i.removeClass("active"),n.addClass("fadeOut fast").one("animationend",function(){n.removeClass("fadeIn fadeOut").css("display","none")}),n.trigger("bubblehide");break;case"toggle":e.bubble("block"==n.css("display")?"hide":"show");break;default:throw new Error(window.app.say("Don't know how to do bubble action %s",t))}return this},t.on("click.twineui",function(t){$(t.target).closest(".bubbleContainer").hasClass("active")||$(".active[data-bubble]").bubble("hide")}),t.on("click.twineui",".bubbleContainer [data-bubble]",function(){var t=$(this),e=t.data("bubble");t.bubble(e),("show"==e||"toggle"==e)&&$.powerTip.hide()}),$.fn.collapse=function(t){var e=$(this),i=e.closest(".collapseContainer");switch(t){case"show":i.addClass("revealed").find(".collapse").slideDown();break;case"hide":i.removeClass("revealed").find(".collapse").slideUp();break;case"toggle":e.collapse(i.hasClass("revealed")?"hide":"show");break;default:throw new Error(window.app.say("Don't know how to do collapse action %s",t))}return this},t.on("click.twineui",".collapseContainer [data-collapse]",function(){var t=$(this);t.collapse(t.data("collapse"))}),$.fn.tab=function(){var t=$(this);return t.addClass("active"),t.closest(".tabs").find("button").not(t).removeClass("active"),$(t.data("content")).show().siblings().hide(),this},t.on("click.twineui",".tabs button",function(){$(this).tab()}),t.on("click.twineui","#notifications .close",function(){var t=$(this).closest("div");t.addClass("fadeOut"),t.one("animationend",function(){$(this).remove()})})}},uninitBody:function(){$("body").data("uiInited")&&(ui.fastclick.destroy(),$("#modalOverlay, #notifications").remove(),$("body").removeClass("iOS safari").off(".twineui").data("uiInited",null))},initEl:function(t){t=$(t),_.defer(function(){t.find("button[title], a[title]").each(function(){$(this).powerTip({placement:$(this).attr("data-tooltip-dir")||"s"})}),t.find(".modal").each(function(){var t=$(this);t.data("modal")||t.data("modal",t.omniWindow({callbacks:{beforeShow:function(t,e){return $("body").addClass("modalOpen"),t.modal.trigger("modalshow"),$("body").hasClass("iOS")&&t.modal.css({position:"absolute",top:$(window).scrollTop()+"px"}),e(t)},afterShow:function(t,e){return t.modal.trigger("modalshown"),_.defer(function(){ui.initEl(t.modal)}),e(t)},beforeHide:function(t,e){return t.modal.data("blockModalHide")&&t.modal.data("blockModalHide")()===!0?!1:($("body").removeClass("modalOpen"),t.modal.trigger("modalhide"),e(t))},afterHide:function(t,e){return t.modal.trigger("modalhidden"),e(t)}},overlay:{selector:"#modalOverlay",hideClass:"hide",animations:{show:function(t,e){t.overlay.addClass("fadeIn"),t.modal.addClass("appear"),e(t)},hide:function(t,e){t.overlay.removeClass("fadeIn").addClass("fadeOut"),t.modal.removeClass("appear").addClass("fadeOut"),t.overlay.one("animationend",function(){t.overlay.removeClass("fadeOut"),t.modal.removeClass("fadeOut").addClass("hide"),e(t)})}}},modal:{hideClass:"hide"}}))}),t.find(".bubble.left, .bubble.right").each(function(){$(this).css("margin-top",0-$(this).outerHeight()/2)}),t.find(".bubble.down").each(function(){$(this).css("top",0-$(this).outerHeight())}),t.find(".tabs button").first().addClass("active"),t.find(".tabContent > div:gt(0)").hide()})},notify:function(t,e){var i=$(ui.notifyTemplate({message:t,className:e}));$("#notifications").append(i),"danger"!=e&&window.setTimeout(function(){$(this).addClass("fadeOut").one("animationend",function(){$(this).remove()})}.bind(i),3e3)},notifyTemplate:_.template('<div class="fadeIn <%= className %>"><button class="close"><i class="fa fa-times"></i></button><%= message %></div>'),confirm:function(t,e,i,n){n=n||{};var a=$(ui.confirmTemplate(_.extend({message:t,buttonLabel:e,modalClass:n.modalClass||"",buttonClass:n.buttonClass||""},window.app.templateProperties))),s=a.find(".modal");s.on("click","button",function(){"yes"==$(this).data("action")&&i&&i(),s.data("modal").trigger("hide")}),$("body").append(a),ui.initEl(a),_.defer(function(){s.data("modal").trigger("show")})},confirmTemplate:_.template('<div><div class="modal hide confirm <%- modalClass %>"><div class="message"><%= message %></div><p class="buttons"><button type="button" class="subtle cancel"><i class="fa fa-times"></i> <%= s("Cancel") %></button> <button type="button" class="<%- buttonClass %>" data-action="yes"><%= buttonLabel %></button></p></div></div>'),prompt:function(t,e,i,n){n=n||{},n.defaultText=n.defaultText||"";var a=$(ui.promptTemplate(_.extend({message:t,defaultText:n.defaultText,buttonLabel:e,modalClass:n.modalClass||"",buttonClass:n.buttonClass||""},window.app.templateProperties))),s=a.find(".modal");s.on("click","button",function(){"yes"==$(this).data("action")&&i&&i(s.find('.prompt input[type="text"]').val()),s.data("modal").trigger("hide")}),s.on("submit","form",function(){s.find('button[data-action="yes"]').click()}),$("body").append(a),ui.initEl(a),_.defer(function(){s.data("modal").trigger("show"),s.find('input[type="text"]').focus()[0].setSelectionRange(0,n.defaultText.length)})},promptTemplate:_.template('<div><div class="modal hide prompt <%- modalClass %>"><form><div class="message"><%= message %></div><p class="prompt"><input type="text" value="<%- defaultText %>" required></p><p class="buttons"><button type="button" class="subtle cancel"><i class="fa fa-times"></i> <%= s("Cancel") %></button> <button type="button" class="<%- buttonClass %>" data-action="yes"><%= buttonLabel %></button></p></form></div></div>')};$(document).ready(ui.initBody);var nwui={active:"undefined"!=typeof process&&"undefined"!=typeof require&&"undefined"!=typeof require("nw.gui"),syncFs:!0,fileLocks:{},init:function(){nwui.gui=require("nw.gui");var t,e=nwui.gui.Window.get(),i=new nwui.gui.Menu({type:"menubar"});

if("darwin"==process.platform)i.createMacBuiltin(window.app.name),t=_.findWhere(i.items,{label:""}),t.submenu.insert(new nwui.gui.MenuItem({label:window.app.say("Toggle Fullscreen"),key:"f",modifiers:"cmd-shift",click:function(){nwui.gui.Window.get().toggleFullscreen()}}),0);else{t=new nwui.gui.MenuItem({label:window.app.name,submenu:new nwui.gui.Menu}),t.submenu.append(new nwui.gui.MenuItem({label:window.app.say("Quit"),key:"q",modifiers:"ctrl",click:function(){nwui.gui.App.closeAllWindows()}})),t.submenu.insert(new nwui.gui.MenuItem({type:"separator"}),0),i.append(t);var n=new nwui.gui.MenuItem({label:window.app.say("Edit"),submenu:new nwui.gui.Menu});n.submenu.append(new nwui.gui.MenuItem({label:window.app.say("Undo"),key:"z",modifiers:"ctrl",click:function(){document.execCommand("undo")}})),n.submenu.append(new nwui.gui.MenuItem({type:"separator"})),n.submenu.append(new nwui.gui.MenuItem({label:window.app.say("Cut"),key:"x",modifiers:"ctrl",click:function(){document.execCommand("cut")}})),n.submenu.append(new nwui.gui.MenuItem({label:window.app.say("Copy"),key:"c",modifiers:"ctrl",click:function(){document.execCommand("copy")}})),n.submenu.append(new nwui.gui.MenuItem({label:window.app.say("Paste"),key:"v",modifiers:"ctrl",click:function(){document.execCommand("paste")}})),n.submenu.append(new nwui.gui.MenuItem({label:window.app.say("Delete"),click:function(){document.execCommand("delete")}})),i.append(n)}nwui.path=require("path"),t.submenu.insert(new nwui.gui.MenuItem({label:window.app.say("Show Library"),click:function(){nwui.gui.Shell.openItem(nwui.path.resolve(nwui.filePath.replace(/\//g,nwui.path.sep)))}}),0),e.menu=i,window.onload=function(){e.show(),e.focus(),_.delay(function(){$("button").blur()})},$("body").on("keyup",function(t){68==t.which&&t.shiftKey&&t.altKey&&t.ctrlKey&&e.showDevTools()}),nwui.fs=require("fs");var a=process.env.HOME||("\\"===process.env.HOMEPATH?!1:process.env.HOMEPATH)||process.env.USERPROFILE,s=a+window.app.say("/Documents");if(nwui.fs.existsSync(s)||(nwui.fs.existsSync(a+window.app.say("/My\\ Documents"))?s=a+window.app.say("/My\\ Documents"):nwui.fs.mkdirSync(s)),nwui.filePath=s+window.app.say("/Twine")+window.app.say("/Stories"),!nwui.fs.existsSync(nwui.filePath)){var o=s+window.app.say("/Twine");nwui.fs.existsSync(o)||nwui.fs.mkdirSync(o),nwui.fs.mkdirSync(nwui.filePath)}global.nwuiFirstRun||(nwui.syncStoryFiles(),nwui.lockStoryDirectory(),global.nwuiFirstRun=!0),$("body").on("click","a",function(t){var e=$(this).attr("href");"string"==typeof e&&e.match(/^https?:/)&&(nwui.gui.Shell.openExternal(e),t.preventDefault())}),process.on("exit",function(){nwui.unlockStoryDirectory()});var r=Story.prototype.initialize;Story.prototype.initialize=function(){r.call(this),this.on("change",_.throttle(function(){_.some(_.keys(this.changedAttributes()),function(t){return"lastUpdated"!=t})&&nwui.syncFs&&0!=this.fetchPassages().length&&nwui.saveStoryFile(this)},100),this),this.on("destroy",function(){nwui.syncFs&&nwui.deleteStoryFile(this)},this)};var l=Passage.prototype.initialize;Passage.prototype.initialize=function(){l.call(this),this.on("change destroy",_.debounce(function(){if(nwui.syncFs){var t=this.fetchStory();t&&nwui.saveStoryFile(t)}},100),this)},StoryListView.StorageQuota.prototype.render=function(){this.$el.css("display","none")},StoryListView.prototype.events["click .showHelp"]=function(){nwui.gui.Shell.openExternal("http://twinery.org/2guide")};var c=StoryListView.prototype.importFile;StoryListView.prototype.importFile=function(t){nwui.syncFs=!1;var e=c.call(this,t);e.addEventListener("load",function(){_.defer(function(){nwui.syncFs=!0,StoryCollection.all().each(nwui.saveStoryFile)})})};var h=WelcomeView.prototype.onRender;WelcomeView.prototype.onRender=function(){var t=_.template($("#templates .welcomeViewNw").html())(window.app.templateProperties);this.$(".save").html(t),h.call(this)}},storyFileName:function(t){return t.get("name").replace(/[^\w\. -]/g,"_")+".html"},saveStoryFile:function(t){try{nwui.unlockStoryDirectory();var e=nwui.fs.openSync(nwui.filePath+"/"+nwui.storyFileName(t),"w");nwui.fs.writeSync(e,t.publish()),nwui.fs.closeSync(e)}catch(i){throw ui.notify(window.app.say("An error occurred while saving your story (%s).",i.message),"danger"),i}finally{nwui.lockStoryDirectory()}},deleteStoryFile:function(t){try{nwui.unlockStoryDirectory(),nwui.fs.unlinkSync(nwui.filePath+"/"+nwui.storyFileName(t))}catch(e){ui.notify(window.app.say("An error occurred while deleting your story (%s).",e.message),"danger")}finally{nwui.lockStoryDirectory()}},syncStoryFiles:function(){nwui.syncFs=!1;for(var t=StoryCollection.all();t.length>0;)t.at(0).destroy();nwui.unlockStoryDirectory();var e=nwui.fs.readdirSync(nwui.filePath);_.each(e,function(t){if(t.match(/\.html$/)){var e=nwui.fs.statSync(nwui.filePath+"/"+t);window.app.importFile(nwui.fs.readFileSync(nwui.filePath+"/"+t,{encoding:"utf-8"}),new Date(Date.parse(e.mtime)))}}),nwui.unlockStoryDirectory(),nwui.syncFs=!0},lockStoryDirectory:function(){try{if("win32"==process.platform)_.each(nwui.fs.readdirSync(nwui.filePath),function(t){nwui.fs.chmodSync(nwui.filePath+"/"+t,292)});else{var t=nwui.fs.statSync(nwui.filePath);nwui.fs.chmodSync(nwui.filePath,128^t.mode)}}catch(e){ui.notify(window.app.say("An error occurred while locking your library (%s).",e.message),"danger")}},unlockStoryDirectory:function(){try{if("win32"==process.platform)_.each(nwui.fs.readdirSync(nwui.filePath),function(t){nwui.fs.chmodSync(nwui.filePath+"/"+t,438)});else{var t=nwui.fs.statSync(nwui.filePath);nwui.fs.chmodSync(nwui.filePath,128|t.mode)}}catch(e){ui.notify(window.app.say("An error occurred while unlocking your library (%s).",e.message),"danger")}}};EventedLocalStorage.prototype=new Backbone.LocalStorage,_.extend(EventedLocalStorage.prototype,{update:function(t){var e=Backbone.LocalStorage.prototype.update.call(this,t);return t.trigger("update"),e}}),CodeMirror.defineOption("prefixTrigger",[],function(t,e){function i(t){if(!t.state.completionActive){var e=t.findWordAt(t.getDoc().getCursor());e.anchor.ch--;for(var i=t.findWordAt(e.anchor),s=t.getRange(i.anchor,i.head),o=n.length;o>=0;o--)if(s==n[o])return void a()}}e.prefixes&&e.callback?t.on("inputRead",i):t.off("inputRead",i);var n=e.prefixes,a=e.callback});var AppPref=Backbone.Model.extend({defaults:{name:"",value:null}});AppPref.withName=function(t,e){var i=AppPrefCollection.all(),n=i.findWhere({name:t});return n?n:null!==e?i.create({name:t,value:e}):void 0};var Passage=Backbone.Model.extend({defaults:_.memoize(function(){return{story:-1,top:0,left:0,tags:[],name:window.app.say("Untitled Passage"),text:window.app.say(window.app.hasPrimaryTouchUI()?"Tap this passage, then the pencil icon to edit it.":"Double-click this passage to edit it.")}}),template:_.template('<tw-passagedata pid="<%- id %>" name="<%- name %>" tags="<%- tags %>" position="<%- left %>,<%- top %>"><%- text %></tw-passagedata>'),initialize:function(){this.on("sync",function(t,e,i){i.noParentUpdate||_.invoke(StoryCollection.all().where({startPassage:this.cid}),"save",{startPassage:this.id})},this),this.on("change",function(t,e){e.noParentUpdate||this.fetchStory().save("lastUpdate",new Date);var i=this.changedAttributes();null!==i.top&&i.top<0&&this.set("top",0),null!==i.left&&i.left<0&&this.set("left",0)},this)},fetchStory:function(){return StoryCollection.all().find(function(t){return t.id==this.get("story")||t.cid==this.get("story")},this)},validate:function(t,e){if(!e.noValidation){if(!t.name||""==t.name)return window.app.say("You must give this passage a name.");if(!e.noDupeValidation)return this.fetchStory().fetchPassages().find(function(e){return t.id!=e.id&&t.name.toLowerCase()==e.get("name").toLowerCase()})?window.app.say('There is already a passage named "%s." Please give this one a unique name.',t.name):void 0}},excerpt:function(){var t=_.escape(this.get("text"));return t.length>100?t.substr(0,99)+"&hellip;":t},links:function(t){var e=this.get("text").match(/\[\[.*?\]\]/g),i={},n=[];if(e)for(var a=0;a<e.length;a++){var s=e[a].replace(/\[\[(?:([^\]]*)\->|([^\]]*?)<\-)([^\]]*)\]\]/g,function(t,e,i,n){return i?i:n}).replace(/\[\[([^\|\]]*?)\|([^\|\]]*)?\]\]/g,"$2").replace(/\[\[|\]\]/g,"");""!=s&&void 0===i[s]&&(n.push(s),i[s]=!0)}return t?_.filter(n,function(t){return!/^\w+:\/\/\/?\w/i.test(t)}):n},replaceLink:function(t,e){var i=new RegExp("\\[\\["+t+"\\]\\]","g"),n=new RegExp("\\[\\[(.*?)(\\||->)"+t+"\\]\\]","g"),a=new RegExp("\\[\\["+t+"<-(.*?)\\]\\]","g"),s=this.get("text"),o=s;o=o.replace(i,"[["+e+"]]"),o=o.replace(n,"[[$1$2"+e+"]]"),o=o.replace(a,"[["+e+"<-$1]]"),o!=s&&this.save({text:o})},matches:function(t){return t.test(this.get("name"))||t.test(this.get("text"))},numMatches:function(t,e){var i=0;t=new RegExp(t.source,"g"+(t.ignoreCase?"i":""));var n=this.get("text").match(t),a=0;return e&&(a=this.get("name").match(t)),i=(a?a.length:0)+(n?n.length:0)},replace:function(t,e,i){this.save(i?{name:this.get("name").replace(t,e),text:this.get("text").replace(t,e)}:{text:this.get("text").replace(t,e)})},publish:function(t){var e=this.get("tags");return this.template({id:t,name:this.get("name"),left:this.get("left"),top:this.get("top"),text:this.get("text"),tags:e?this.get("tags").join(" "):""})},intersects:function(t){var e=Passage.padding,i=Passage.width,n=Passage.height;return this.get("left")-e<t.get("left")+i+e&&this.get("left")+i+e>t.get("left")-e&&this.get("top")-e<t.get("top")+n+e&&this.get("top")+n+e>t.get("top")-e},displace:function(t){var e,i,n=Passage.padding,a=this.get("left")-n,s=a+Passage.width+2*n,o=this.get("top")-n,r=o+Passage.height+2*n,l=t.get("left")-n,c=l+Passage.width+2*n,h=t.get("top")-n,d=h+Passage.height+2*n,u=Math.min(s,c)-Math.max(a,l),p=Math.min(r,d)-Math.max(o,h);if(0!=u){var f=l-a+Passage.width+n,m=s-l+n;e=m>f?-f:m}if(0!=p){var g=h-o+Passage.height+n,w=r-h+n;i=w>g?-g:w}Math.abs(e)>Math.abs(i)?t.set("top",h+i):t.set("left",l+e)}},{width:100,height:100,padding:12.5});Passage.withId=function(t){return PassageCollection.all().findWhere({id:t})};var StoryFormat=Backbone.Model.extend({loaded:!1,properties:{},defaults:_.memoize(function(){return{name:window.app.say("Untitled Story Format"),url:"",userAdded:!0}}),load:function(t){if(this.loaded)return void(t&&t());var e=window.storyFormat||null;window.storyFormat=function(i){this.properties=i,this.loaded=!0,this.properties.setup&&this.properties.setup.call(this),window.storyFormat=e,t&&t()}.bind(this);var i=$("<script></script>");$("body").append(i),i.on("load",function(){if(!this.loaded){var e=new Error("Story format source did not call window.storyFormat()");if(!t)throw e;t(e)}i.remove()}.bind(this)).on("error",function(){var e=new Error("Could not load story format source");if(!t)throw e;t(e),i.remove()}.bind(this)),i.attr("src",this.get("url")+"?"+(new Date).getTime()),window.setTimeout(function(){if(i.parent().length>0){var e=new Error("Could not load story format source");if(!t)throw e;t(e),i.remove()}}.bind(this),1e4)},publish:function(t,e,i,n){this.load(function(a){if(a)return void n(a);try{var s=this.properties.source;s=s.replace(/{{STORY_NAME}}/g,function(){return _.escape(t.get("name"))}),s=s.replace(/{{STORY_DATA}}/g,function(){return t.publish(e,i)}),_.each(this.get("placeholders"),function(e){var i=t.get(e.name);null!==i&&(s=s.replace(e.name,function(){return i}))}),n(null,s)}catch(o){n(o)}}.bind(this))}});StoryFormat.withName=function(t){return StoryFormatCollection.all().findWhere({name:t})};var Story=Backbone.Model.extend({defaults:_.memoize(function(){return{name:window.app.say("Untitled Story"),startPassage:-1,zoom:1,snapToGrid:!1,stylesheet:"",script:"",storyFormat:AppPref.withName("defaultFormat").get("value")||"Harlowe",lastUpdate:new Date,ifid:UUID().toUpperCase()}}),template:_.template('<tw-storydata name="<%- storyName %>" startnode="<%- startNode %>" creator="<%- appName %>" creator-version="<%- appVersion %>" ifid="<%- ifid %>" format="<%- storyFormat %>" options="<%= options %>"><style role="stylesheet" id="twine-user-stylesheet" type="text/twine-css"><%= stylesheet %></style><script role="script" id="twine-user-script" type="text/twine-javascript"><%= script %></script><%= passageData %></tw-storydata>'),initialize:function(){this.on("destroy",function(){for(var t=this.fetchPassages();t.length>0;)t.at(0).destroy()},this),this.on("sync",function(t,e,i){i.noChildUpdate||_.invoke(PassageCollection.all().where({story:this.cid}),"save",{story:this.id})},this),this.on("change",function(){void 0===this.changedAttributes().lastUpdate&&this.set("lastUpdate",new Date)},this)},fetchPassages:function(){var t=PassageCollection.all();return t.reset(t.filter(function(t){return t.get("story")==this.id||t.get("story")==this.cid},this)),t},publish:function(t,e,i){var n="",a=e||this.get("startPassage"),s=this.fetchPassages();if(!i){if(!a)throw new Error(window.app.say("There is no starting point set for this story."));if(!s.findWhere({id:a}))throw new Error(window.app.say("The passage set as starting point for this story does not exist."))}return s.each(function(t,i){n+=t.publish(i+1),t.id==a&&(e=i+1)}),this.template({storyName:this.get("name"),startNode:e||"",appName:window.app.name,appVersion:window.app.version,passageData:n,stylesheet:this.get("stylesheet"),script:this.get("script"),options:t?t.join(" "):null,storyFormat:this.get("storyFormat"),ifid:this.get("ifid")})},duplicate:function(t){var e=new StoryCollection,i=new PassageCollection,n=this.clone();n.unset("id"),n.collection=e,n.save({name:t},{wait:!0});var a,s=this.get("startPassage");return this.fetchPassages().each(function(t){var e=t.clone();e.unset("id"),e.collection=i,e.set("story",n.id),e.save(),t.id==s&&(a=e)}),a&&n.save({startPassage:a.id}),n}});Story.withId=function(t){return StoryCollection.all().findWhere({id:t})};var AppPrefCollection=Backbone.Collection.extend({model:AppPref,localStorage:new Backbone.LocalStorage("twine-prefs")});AppPrefCollection.all=function(){var t=new AppPrefCollection;return t.fetch(),t};var PassageCollection=Backbone.Collection.extend({model:Passage,localStorage:new EventedLocalStorage("twine-passages")});PassageCollection.all=function(){var t=new PassageCollection;return t.fetch(),t};var StoryCollection=Backbone.Collection.extend({model:Story,localStorage:new EventedLocalStorage("twine-stories"),order:"name",reverseOrder:!1,comparator:function(t,e){var i;switch(this.order){case"name":i=t.get("name")<e.get("name")?-1:1;break;case"lastUpdate":var n=new Date(t.get("lastUpdate")),a=new Date(e.get("lastUpdate"));i=n.getTime()<a.getTime()?-1:1;break;default:throw new Error(window.app.say("don't know how to sort stories by %s",this.order))}return i*(this.reverseOrder?-1:1)}});StoryCollection.all=function(){var t=new StoryCollection;return t.fetch(),t};var StoryFormatCollection=Backbone.Collection.extend({model:StoryFormat,localStorage:new Backbone.LocalStorage("twine-storyformats")});StoryFormatCollection.all=function(){var t=new StoryFormatCollection;return t.fetch(),t};var LocaleView=Backbone.Marionette.ItemView.extend({template:"#templates .localeView",setLocale:function(t){if("string"!=typeof t)throw new Error(window.app.say("Can't set locale to nonstring: %s",t));AppPref.withName("locale").save({value:t}),window.location.hash="stories",window.location.reload()},events:{"click [data-locale]":function(t){this.setLocale($(t.target).closest("[data-locale]").data("locale"))}}}),WelcomeView=Backbone.Marionette.ItemView.extend({template:"#templates .welcomeView",initialize:function(){this.welcomePref=AppPref.withName("welcomeSeen")},finish:function(){this.welcomePref||(this.welcomePref=new AppPref({name:"welcomeSeen"}),AppPrefCollection.all().add(this.welcomePref)),this.welcomePref.save({value:!0}),window.location.hash="#stories"},onRender:function(){this.$("div:first-child").css("display","block").addClass("appear"),this.$el.on("click","button, a.done",function(t){var e=$(t.target),i=e.closest("div").next("div");e.closest("p").addClass("fadeOut").on("animationend webkitAnimationEnd MSAnimationEnd",function(){$(this).remove()}),e.hasClass("done")?this.finish():(i.css("display","block").addClass("slideDown"),$("body").animate({scrollTop:i.position().top+100}))}.bind(this))}}),StoryItemView=Marionette.ItemView.extend({template:"#templates .storyItemView",initialize:function(t){this.parentView=t.parentView,this.passages=t.passages,this.listenTo(this.model,"change:name",function(){this.render(),this.preview.renderPassages()})},onDomRefresh:function(){this.preview=new StoryItemView.Preview({el:this.$(".preview"),parent:this})},edit:function(t){var e=$('<div id="storyEditProxy" class="fullAppear fast"></div>');for(var i in StoryEditView.prototype.ZOOM_MAPPINGS)if(StoryEditView.prototype.ZOOM_MAPPINGS[i]==this.model.get("zoom")){e.addClass("zoom-"+i);break}var n=t?t.pageX:$(window).width()/2,a=t?t.pageY:$(window).height()/2;e.css({transformOrigin:n+"px "+a+"px","-webkit-transform-origin":n+"px "+a+"px"}).one("animationend",function(){window.location.hash="#stories/"+this.model.id}.bind(this)),this.parentView.$el.append(e)},play:function(){void 0===Passage.withId(this.model.get("startPassage"))?ui.notify(window.app.say('This story does not have a starting point. Edit this story and use the <i class="fa fa-rocket"></i> icon on a passage to set this.'),"danger"):window.open("#stories/"+this.model.id+"/play","twinestory_play_"+this.model.id)},test:function(){void 0===Passage.withId(this.model.get("startPassage"))?ui.notify(window.app.say('This story does not have a starting point. Edit this story and use the <i class="fa fa-rocket"></i> icon on a passage to set this.'),"danger"):window.open("#stories/"+this.model.id+"/test","twinestory_test_"+this.model.id)},publish:function(){void 0===Passage.withId(this.model.get("startPassage"))?ui.notify(window.app.say('This story does not have a starting point. Use the <i class="fa fa-rocket"></i> icon on a passage to set this.'),"danger"):window.app.publishStory(this.model,this.model.get("name")+".html")},confirmDelete:function(){window.ui.confirm(window.app.say("Are you sure you want to delete &ldquo;%s&rdquo;? This cannot be undone.",this.model.get("name")),'<i class="fa fa-trash-o"></i> '+window.app.say("Delete Forever"),this["delete"].bind(this),{buttonClass:"danger"})},rename:function(){window.ui.prompt(window.app.say("What should &ldquo;%s&rdquo; be renamed to?",this.model.get("name")),'<i class="fa fa-ok"></i> '+window.app.say("Rename"),function(t){this.model.save({name:t})}.bind(this),{defaultText:this.model.get("name")})},confirmDuplicate:function(){window.ui.prompt(window.app.say("What should the duplicate be named?"),'<i class="fa fa-copy"></i> '+window.app.say("Duplicate"),function(t){var e=this.model.duplicate(t);this.parentView.collection.add(e)}.bind(this),{defaultText:window.app.say("%s Copy",this.model.get("name"))})},"delete":function(){this.$(".story").addClass("disappear").one("animationend",function(){this.model.destroy()}.bind(this))},appear:function(){this.$(".story").addClass("appear")},events:{"click .confirmDelete":"confirmDelete","click .confirmDuplicate":"confirmDuplicate","click .rename":"rename","click .edit":"edit","click .play":"play","click .test":"test","click .publish":"publish"}});StoryItemView.Preview=Backbone.View.extend({appearDuration:500,initialize:function(t){this.parent=t.parent,this.passagesRendered=!1,this.svg=SVG(this.el),this.hue=0;for(var e=this.parent.model.get("name"),i=e.length-1;i>=0;i--)this.hue+=e.charCodeAt(i);this.hue=this.hue%360,this.$el.closest(".story").css("background","hsl("+this.hue+", 15%, 95%)")},renderPassages:function(t){if(this.svg.height(this.parent.$(".story").innerHeight()-this.parent.$(".label").outerHeight()),this.parent.passages.length>1){var e=0;_.each(this.parent.passages,function(t){var i=t.get("text").length;i>e&&(e=i)});var i="hsl("+this.hue+", 88%, 40%)",n="hsl("+(this.hue-30)%360+", 88%, 40%)",a="hsl("+(this.hue+30)%360+", 88%, 40%)",s=Number.POSITIVE_INFINITY,o=Number.POSITIVE_INFINITY,r=Number.NEGATIVE_INFINITY,l=Number.NEGATIVE_INFINITY;_.each(this.parent.passages,function(t,c){var h=t.get("text").length/e,d=100+200*h,u=t.get("left"),p=t.get("top"),f=this.svg.circle().center(u+50,p+50);f.fill(c%3==0?{color:i,opacity:.9*h}:c%2==0?{color:n,opacity:.9*h}:{color:a,opacity:.9*h}),f.animate(this.appearDuration,">").radius(d/2),s>u-d&&(s=u-d),u+d>r&&(r=u+d),o>p-d&&(o=p-d),p+d>l&&(l=p+d)}.bind(this)),this.svg.viewbox(s,o,Math.abs(s)+r,Math.abs(o)+l)}else 1==this.parent.passages.length&&(this.svg.circle().center(5,5).fill("hsl("+this.hue+", 88%, 40%)").animate(this.appearDuration,">").radius(2.5),this.svg.viewbox(0,0,10,10));this.passagesRendered=!0,t&&t()}});var StoryListView=Backbone.Marionette.CompositeView.extend({childView:StoryItemView,childViewContainer:".stories",childViewOptions:function(t){return this.previewCache||(this.previewCache=PassageCollection.all()),{parentView:this,passages:this.previewCache.where({story:t.get("id")})}},template:"#templates .storyListView",DONATION_DELAY:12096e5,UPDATE_CHECK_DELAY:864e5,appearFast:!1,initialize:function(){this.sortByDate(),this.collection.on("sort",function(){this.render(),this.children.each(function(t){t.preview.passagesRendered=!1}),this.showNextPreview()}.bind(this)),this.collection.on("add",function(){this.previewCache=null}.bind(this)),this.collection.on("reset",function(){this.previewCache=null,this.render()}.bind(this))},onShow:function(){if(ui.initEl(this.$el),this.syncStoryCount(),this.storageQuota=new StoryListView.StorageQuota({parent:this,el:this.$(".quota")}),this.formatsModal=new StoryListView.FormatsModal({parent:this,el:this.$("#formatsModal")}),this.$(".app-version").text(window.app.version),this.previouslyEditing){var t=$('<div id="storyEditProxy" class="fullAppear fast reverse">');t.one("animationend",function(){t.remove()}),this.children.find(function(e){if(e.model.get("id")==this.previouslyEditing){var i=e.$(".story"),n=i.offset();return n.left+=i.outerHeight()/2,t.css({"-webkit-transform-origin":n.left+"px "+n.top+"px",transformOrigin:n.left+"px "+n.top+"px"}),!0}}.bind(this)),this.$el.append(t)}if(!this.appearFast){var e=AppPref.withName("firstRunTime",(new Date).getTime()),i=AppPref.withName("donateShown",!1);if(!i.get("value")&&(new Date).getTime()>e.get("value")+this.DONATION_DELAY)_.delay(function(){this.$("#donateModal").data("modal").trigger("show")}.bind(this),50),i.save({value:!0});else{var n=AppPref.withName("lastUpdateSeen",window.app.buildNumber);n.get("value")<window.app.buildNumber&&n.save({value:window.app.buildNumber});var a=AppPref.withName("lastUpdateCheckTime",(new Date).getTime());(new Date).getTime()>a.get("value")+this.UPDATE_CHECK_DELAY&&window.app.checkForUpdate(n.get("value"),function(t){n.save({value:t.buildNumber}),$("#appUpdateModal .version").text(t.version),$("#appUpdateModal a.download").attr("href",t.url),_.delay(function(){$("#appUpdateModal").data("modal").trigger("show")}.bind(this),50)})}}},onDomRefresh:function(){_.defer(this.showNextPreview.bind(this))},onAddChild:function(){this.syncStoryCount()},onRemoveChild:function(){this.syncStoryCount()},addStory:function(t){var e=this.collection.create({name:this.$("input.newName").val()});this.children.findByModel(e).edit(),t.preventDefault()},saveArchive:function(){window.app.saveArchive()},importFile:function(t){var e=new FileReader,i=this.$(".importStory").closest(".bubbleContainer");return i.find(".form").addClass("hide"),i.find(".working").removeClass("hide"),e.addEventListener("load",function(t){var e="",n="";try{var a=window.app.importFile(t.target.result);a>0?n=window.app.sayPlural("%d story was imported.","%d stories were imported.",a):(e="danger",n="Sorry, no stories could be found in this file.")}catch(t){e="danger",n="An error occurred while trying to import this file. ("+t.message+")"}ui.notify(n,e),this.collection.reset(StoryCollection.all().models),i.find(".form").removeClass("hide"),i.find(".working").addClass("hide"),this.$(".importStory").bubble("hide"),ui.initEl(this.$el)}.bind(this)),e.readAsText(t.target.files[0],"UTF-8"),e},showNextPreview:function(){var t=this.children.find(function(t){return!t.preview.passagesRendered});void 0!==t&&t.preview.renderPassages(this.showNextPreview.bind(this))},sortByName:function(){this.collection.order="name",this.collection.reverseOrder=!1,this.collection.sort(),this.$(".sortByDate").removeClass("active"),this.$(".sortByName").addClass("active")},sortByDate:function(){this.collection.order="lastUpdate",this.collection.reverseOrder=!0,this.collection.sort(),this.$(".sortByDate").addClass("active"),this.$(".sortByName").removeClass("active")},syncStoryCount:function(){this.collection.length>0?(this.$(".stories").css("display","block"),this.$(".noStories").css("display","none")):(this.$(".stories").css("display","none"),this.$(".noStories").css("display","block")),document.title=window.app.sayPlural("%d Story","%d Stories",this.collection.length)},events:{"submit #addStoryForm":"addStory","click .saveArchive":"saveArchive","change .importFile":"importFile","click .sortByDate":"sortByDate","click .sortByName":"sortByName","click .showFormats":function(){this.formatsModal.open()},"click .showLocale":function(){window.location.hash="locale"},"click .showHelp":function(){window.open("http://twinery.org/2guide")}}});StoryListView.FormatsModal=Backbone.View.extend({initialize:function(t){this.parent=t.parent,this.itemTemplate=_.template($(".formatItem").html())},open:function(){this.$(".error").hide(),this.$(".storyFormatList, .proofingFormatList").empty(),this.formatsToLoad=StoryFormatCollection.all(),this.loadNextFormat(),this.$el.data("modal").trigger("show")},close:function(){this.$el.data("modal").trigger("hide")},loadNextFormat:function(){if(this.formatsToLoad.length>0){var t=this.formatsToLoad.at(0);t.load(function(e){if(void 0===e){var i=t.get("url").replace(/\/[^\/]*?$/,""),n=_.extend(t.properties,{path:i,userAdded:t.get("userAdded")},window.app.templateProperties),a=$(this.itemTemplate(n));n.proofing?this.$(".proofingFormatList").append(a):this.$(".storyFormatList").append(a)}else ui.notify(window.app.say("The story format &ldquo;%1$s&rdquo; could not be loaded (%2$s).",t.get("name"),e.message),"danger");this.formatsToLoad.remove(t),this.loadNextFormat()}.bind(this))}else this.syncButtons(),this.$(".loading").hide()},addFormat:function(t){var e=new StoryFormat({url:t});this.$(".loading").fadeIn(),e.load(function(i){if(i)this.$(".error").fadeIn().html(window.app.say("The story format at %1$s could not be added (%2$s).",t,i.message));else{StoryFormatCollection.all().create({name:e.properties.name,url:t});var n=t.replace(/\/[^\/]*?$/,""),a=_.extend(e.properties,{path:n,userAdded:!0}),s=$(this.itemTemplate(a));a.proofing?(this.$(".proofingFormatList").append(s),this.$(".showProofingFormats").tab(),s.hide().slideDown()):(this.$(".storyFormatList").append(s),this.$(".showStoryFormats").tab(),s.hide().slideDown()),this.$('.addFormat input[type="text"]').val(""),this.$(".error").hide()}this.$(".loading").hide()}.bind(this))},removeFormat:function(t){StoryFormat.withName(t).destroy()},setDefaultFormat:function(t){AppPref.withName("defaultFormat").save({value:t})},setProofingFormat:function(t){AppPref.withName("proofingFormat").save({value:t})},syncButtons:function(){var t=AppPref.withName("defaultFormat").get("value"),e=AppPref.withName("proofingFormat").get("value");this.$(".storyFormatList .format").each(function(){var e=$(this);e.data("format")==t?e.find(".setDefault").addClass("active"):e.find(".setDefault").removeClass("active")}),this.$(".proofingFormatList .format").each(function(){var t=$(this);t.data("format")==e?t.find(".setDefault").addClass("active"):t.find(".setDefault").removeClass("active")})},events:{"click .showRemoveConfirm":function(t){var e=$(t.target).closest(".buttons");e.find(".normalButtons").hide(),e.find(".removeConfirm").fadeIn()},"click .hideRemoveConfirm":function(t){var e=$(t.target).closest(".buttons");e.find(".normalButtons").fadeIn(),e.find(".removeConfirm").hide()},"click .remove":function(t){var e=$(t.target).closest(".format");this.removeFormat(e.data("format")),e.slideUp()},"click .setDefault":function(t){var e=$(t.target).closest(".format"),i=e.data("format");if(e.closest(".storyFormatList").length>0)this.setDefaultFormat(i);else{if(!(e.closest(".proofingFormatList").length>0))throw new Error(window.app.say("Don't know what kind of format to set as default"));this.setProofingFormat(i)}this.syncButtons()},"submit .addFormat":function(t){this.addFormat(this.$('.addFormat input[type="text"]').val()),t.preventDefault()}}}),StoryListView.StorageQuota=Backbone.View.extend({initialize:function(t){this.parent=t.parent,this.render()},render:function(){var t=this.$(".used"),e=this.$(".percent");if(0==this.parent.collection.length)return t.css("display","none"),void e.text(window.app.say("%d%% space available",100));var i=JSON.stringify(window.localStorage).length,n=new Array(102400).join("x"),a=102400,s=0,o=window.setInterval(function(){var r=!1;try{window.localStorage.setItem("__quotatest"+s,n),a+=102400,s++;var l=Math.round(i/(i+a)*100);e.text(window.app.say("%d%% space available",100-l)),1>=l?(t.css("width","0.25em"),e.text(window.app.say("%d%% space available",99)),r=!0):t.css("width",l+"%")}catch(c){r=!0}if(r){for(var h=0;s>=h;h++)window.localStorage.removeItem("__quotatest"+h);window.clearInterval(o)}},20)}});var PassageItemView=Marionette.ItemView.extend({template:"#templates .passageItemView",className:"passage",selected:!1,actuallyDragged:!1,animateMovement:!1,initialize:function(t){this.parentView=t.parentView,this.listenTo(this.model,"change",this.render).listenTo(this.model,"change:text",this.createLinkedPassages).listenTo(this.parentView.model,"change:zoom",this.render).listenTo(this.parentView.model,"change:startPassage",this.render),this.prepDragBound=this.prepDrag.bind(this),this.followDragBound=this.followDrag.bind(this),this.finishDragBound=this.finishDrag.bind(this),this.trackDragBound=this.trackDrag.bind(this),this.endDragBound=this.endDrag.bind(this)},onDomRefresh:function(){var t=this.parentView.model.get("zoom"),e=this.model.get("top")*t,i=this.model.get("left")*t;this.$el.attr("data-id",this.model.id).css("position","absolute"),_.every(this.model.links(!0),function(t){return this.parentView.collection.findWhere({name:t})},this)?this.$el.removeClass("brokenLink"):this.$el.addClass("brokenLink");var n=this.parentView.model.get("startPassage");this.model.id==n||this.model.cid==n?this.$el.addClass("start"):this.$el.removeClass("start"),this.animateMovement?(this.$el.animate({left:i,top:e},100),_.delay(function(t){t.set({left:t.get("left")+1e-4})},100,this.model)):this.$el.css({left:i,top:e})},onDestroy:function(){this.deselect()},serializeData:function(){var t=this.model.toJSON();return t.excerpt=this.model.excerpt(),t},confirmDelete:function(t){if(t.shiftKey)this["delete"]();else{var e=window.app.say("Are you sure you want to delete &ldquo;%s&rdquo;? This cannot be undone.",this.model.get("name"));window.app.hasPrimaryTouchUI()||(e+="<br><br>"+window.app.say("(Hold the Shift key when deleting to skip this message.)")),ui.confirm(e,'<i class="fa fa-trash-o"></i> '+window.app.say("Delete"),this["delete"].bind(this),{buttonClass:"danger"})}},"delete":function(){var t=this.model;this.disappear(function(){t.destroy()})},edit:function(){this.parentView.passageEditor.model=this.model,this.parentView.passageEditor.open()},createLinkedPassages:function(){var t=[];if(this.model.previous("text")){var e=this.model.get("text");this.model.set({text:this.model.previous("text")},{silent:!0}),t=_.filter(this.model.links(!0),function(t){return null!==this.parentView.collection.findWhere({name:t})},this),this.model.set({text:e},{silent:!0})}var i=this.model.get("top")+1.5*Passage.height,n=this.model.get("left");_.each(this.model.links(!0),function(e){this.parentView.collection.findWhere({name:e
})||-1!=t.indexOf(e)||(_.defer(this.parentView.addPassage.bind(this.parentView),e,n,i),n+=1.5*Passage.width)},this)},test:function(){this.parentView.test(this.model.id)},setAsStart:function(){this.parentView.model.save({startPassage:this.model.id})},appear:function(t){t&&this.$el.on("animationend webkitAnimationEnd MSAnimationEnd",function(){t(),$(this).off("animationend webkitAnimationEnd MSAnimationEnd")}),this.$el.addClass("fallIn")},disappear:function(t){t&&this.$el.on("animationend webkitAnimationEnd MSAnimationEnd",function(){t(),$(this).off("animationend webkitAnimationEnd MSAnimationEnd")}),this.$el.removeClass("fallIn").addClass("disappear")},select:function(){this.selected||(this.selected=!0,this.$el.addClass("selected"),$("body").on("passagedragstart",this.prepDragBound),$("body").on("passagedrag",this.followDragBound),$("body").on("passagedragend",this.finishDragBound))},deselect:function(){this.selected&&(this.selected=!1,this.$el.removeClass("selected"),$("body").off("passagedragstart",this.prepDragBound),$("body").off("passagedrag",this.followDragBound),$("body").off("passagedragend",this.finishDragBound))},highlight:function(){this.$el.addClass("highlight")},unhighlight:function(){this.$el.removeClass("highlight")},handleMouseDown:function(t){t.shiftKey||t.ctrlKey?this.selected?this.deselect():this.select():(this.selected||this.parentView.children.each(function(t){t!=this&&t.deselect()},this),this.select()),this.beginDrag(t),t.stopPropagation()},handleMouseUp:function(t){t.shiftKey||t.ctrlKey||this.actuallyDragged||this.$el==this.parentView.lastMousedown||$.contains(this.$el,this.parentView.lastMousedown)||this.parentView.children.each(function(t){t!=this&&t.deselect()},this)},beginDrag:function(t){if(t.pageX&&t.pageY)this.dragMouseStart={x:t.pageX,y:t.pageY};else{if(!t.originalEvent.targetTouches)throw new Error(window.app.say("Don't see either mouse or touch coordinates on event"));t=t.originalEvent,this.dragMouseStart={x:t.targetTouches[0].pageX,y:t.targetTouches[0].pageY},this.dragTouchId=t.targetTouches[0].identifier}this.actuallyDragged=!1,$("#storyEditView").addClass("draggingPassages"),$("body").on({touchmove:this.trackDragBound,mousemove:this.trackDragBound,mouseup:this.endDragBound,touchend:this.endDragBound}).trigger("passagedragstart",this.dragMouseStart)},prepDrag:function(t){this.dragStart={left:parseInt(this.$el.css("left")),top:parseInt(this.$el.css("top"))}},trackDrag:function(t){var e;if(this.actuallyDragged=!0,null!==this.dragTouchId&&t.originalEvent.touches){t.preventDefault(),t=t.originalEvent;for(var i=0;i<t.touches.length;i++)if(t.touches[i].identifier==this.dragTouchId){e=t.touches[i];break}if(!e)throw new Error(window.app.say("Couldn't find original touch ID in movement event"))}else e=t;$("body").trigger($.Event("passagedrag",{x:e.pageX-this.dragMouseStart.x,y:e.pageY-this.dragMouseStart.y}))},followDrag:function(t){this.$el.css({left:Math.max(this.dragStart.left+t.x,0),top:Math.max(this.dragStart.top+t.y,0)})},endDrag:function(t){$("#storyEditView").removeClass("draggingPassages"),$("body").off({touchmove:this.trackDragBound,mousemove:this.trackDragBound,mouseup:this.endDragBound,touchend:this.endDragBound}).trigger("passagedragend"),_.defer(function(){this.actuallyDragged=!1}.bind(this))},finishDrag:function(t){var e=this.parentView.model.get("zoom");this.model.set({top:parseInt(this.$el.css("top"))/e,left:parseInt(this.$el.css("left"))/e}),_.defer(function(){this.animateMovement=!0,this.parentView.positionPassage(this.model,function(t){return!this.parentView.children.findByModel(t).selected}.bind(this)),this.animateMovement=!1,this.model.save()}.bind(this))},events:{"mousedown .frame":"handleMouseDown","touchstart .frame":"handleMouseDown","mouseup .frame":"handleMouseUp","touchend .frame":"handleMouseUp","click .delete":"confirmDelete","click .edit":"edit","click .test":"test","click .setAsStart":"setAsStart",dblclick:"edit"}}),StoryEditView=Marionette.CompositeView.extend({ZOOM_MAPPINGS:{big:1,medium:.6,small:.25},childView:PassageItemView,childViewContainer:".passages .content",childViewOptions:function(){return{parentView:this}},template:"#templates .storyEditView",initialize:function(){this.listenTo(this.model,"change:zoom",this.syncZoom).listenTo(this.model,"change:name",this.syncName).listenTo(this.model,"error",function(t,e,i){ui.notify(window.app.say("A problem occurred while saving your changes (%s).",e),"danger")}),this.collection=this.model.fetchPassages(),this.listenTo(this.collection,"change:top change:left",this.resize).listenTo(this.collection,"change:name",function(t){_.invoke(this.collection.models,"replaceLink",t.previous("name"),t.get("name"))}).listenTo(this.collection,"add",function(t){1==this.collection.length&&this.model.save({startPassage:t.id})}).listenTo(this.collection,"error",function(t,e,i){ui.notify(window.app.say("A problem occurred while saving your changes (%s).",e),"danger")})},onShow:function(){ui.initEl(this.$el),this.syncName(),$(document).on("keydown",function(t){32==t.keyCode&&0==$("input:focus, textarea:focus").length&&(this.startMouseScrolling(),t.preventDefault())}.bind(this)),$(document).on("keyup",function(t){32==t.keyCode&&0==$("input:focus, textarea:focus").length&&(this.stopMouseScrolling(),t.preventDefault())}.bind(this)),$(document).on("keyup",function(t){if(46==t.keyCode){var e=this.children.filter(function(t){return t.selected});switch(e.length){case 0:return;case 1:this.deleteSelectedPassages();break;default:var i=window.app.sayPlural("Are you sure you want to delete this passage?","Are you sure you want to delete these %d passages? This cannot be undone.",e.length);ui.confirm(i,'<i class="fa fa-trash-o"></i> '+window.app.say("Delete"),this.deleteSelectedPassages.bind(this),{buttonClass:"danger"})}}}.bind(this)),this.$el.on("click",".storyBubble",function(){$(".storyBubble").bubble("hide")}),this.resize(),$(window).on("resize",_.debounce(this.resize.bind(this),500)),this.syncZoom(),this.linkManager=new StoryEditView.LinkManager({el:this.el,parent:this}),this.toolbar=new StoryEditView.Toolbar({el:this.$(".toolbar"),parent:this}),this.passageEditor=new StoryEditView.PassageEditor({el:this.$("#passageEditModal"),parent:this}),this.scriptEditor=new StoryEditView.ScriptEditor({el:this.$("#scriptEditModal"),parent:this}),this.styleEditor=new StoryEditView.StyleEditor({el:this.$("#stylesheetEditModal"),parent:this}),this.search=new StoryEditView.Search({el:this.$(".searchContainer"),parent:this}),this.searchModal=new StoryEditView.SearchModal({el:this.$("#searchModal"),parent:this}),this.renameModal=new StoryEditView.RenameStoryModal({el:this.$("#renameStoryModal"),parent:this}),this.storyFormatModal=new StoryEditView.StoryFormatModal({el:this.$("#storyFormatModal"),parent:this}),this.statsModal=new StoryEditView.StatsModal({el:this.$("#statsModal"),parent:this}),window.app.hasPrimaryTouchUI()||(this.marquee=new StoryEditView.Marquee({el:this.$(".passages"),parent:this})),0==this.collection.length?this.addPassage():this.$(".passages .content").addClass("fadeIn fast")},onDestroy:function(){this.linkManager.destroy(),$(document).off("keydown"),$(document).off("keyup"),$(window).off("resize")},addPassage:function(t,e,i){var n=this.model.get("zoom");if(!e){var a=this.$(".passage:first").width()/2;e=($(window).scrollLeft()+$(window).width()/2)/n-a}if(!i){var s=this.$(".passage:first").height()/2;i=($(window).scrollTop()+$(window).height()/2)/n-s}if(t=t||Passage.prototype.defaults().name,this.collection.findWhere({name:t})){var o=t,r=0;do r++;while(this.collection.findWhere({name:o+" "+r}));t=o+" "+r}var l=this.collection.create({name:t,story:this.model.id,left:e,top:i},{wait:!0});this.positionPassage(l),l.save(),this.children.findByModel(l).appear()},deleteSelectedPassages:function(){_.invoke(this.children.filter(function(t){return t.selected}),"delete")},play:function(){if(void 0===Passage.withId(this.model.get("startPassage")))return void ui.notify(window.app.say('This story does not have a starting point. Use the <i class="fa fa-rocket"></i> icon on a passage to set this.'),"danger");var t=window.open("","twinestory_play_"+this.model.id);"about:blank"==t.location.href?t.location.href="#stories/"+this.model.id+"/play":(t.location.reload(),ui.notify(window.app.say("Refreshed the playable version of your story in the previously-opened tab or window.")))},test:function(t){var e="#stories/"+this.model.id+"/test";t&&(e+="/"+t);var i=!1;if(i=t?void 0!==Passage.withId(t):void 0!==Passage.withId(this.model.get("startPassage")),!i)return void ui.notify(window.app.say('This story does not have a starting point. Use the <i class="fa fa-rocket"></i> icon on a passage to set this.'),"danger");var n=window.open("","twinestory_test_"+this.model.id);"about:blank"==n.location.href?n.location.href=e:(n.location.reload(),ui.notify(window.app.say("Refreshed the test version of your story in the previously-opened tab or window.")))},proof:function(){window.open("#stories/"+this.model.id+"/proof","twinestory_proof_"+this.model.id)},publish:function(t){void 0===Passage.withId(this.model.get("startPassage"))?ui.notify(window.app.say('This story does not have a starting point. Use the <i class="fa fa-rocket"></i> icon on a passage to set this.'),"danger"):window.app.publishStory(this.model,this.model.get("name")+".html")},resize:function(){var t=$(window).width(),e=$(window).height(),i=this.model.get("zoom"),n=t,a=e;if(this.collection.length>0){var s=this.collection.max(function(t){return t.get("left")}),o=this.collection.max(function(t){return t.get("top")}),r=i*(s.get("left")+Passage.width),l=i*(o.get("top")+Passage.height);n=Math.max(r,t),a=Math.max(l,e)}else n=t,a=e;n+=.5*t,a+=.5*e,this.$(".passages").css({width:n,height:a}),this.$("canvas").attr({width:n,height:a})},startMouseScrolling:function(){this.mouseScrollStart=this.mouseScrollStart||{},this.mouseScrollStart.x=null,this.mouseScrollStart.y=null,this.pageScrollStart=this.pageScrollStart||{},this.pageScrollStart.x=$(window).scrollLeft(),this.pageScrollStart.y=$(window).scrollTop(),$("#storyEditView").addClass("scrolling"),$(window).on("mousemove",{self:this},this.mouseScroll)},stopMouseScrolling:function(){$("#storyEditView").removeClass("scrolling"),$(window).off("mousemove",this.mouseScroll)},mouseScroll:function(t){var e=t.data.self;e.mouseScrollStart.x||e.mouseScrollStart.y?($(window).scrollLeft(e.pageScrollStart.x-(t.pageX-e.mouseScrollStart.x)),$(window).scrollTop(e.pageScrollStart.y-(t.pageY-e.mouseScrollStart.y))):(e.mouseScrollStart.x=t.pageX,e.mouseScrollStart.y=t.pageY)},positionPassage:function(t,e){if(this.collection.each(function(i){if((!e||e(i))&&i.id!=t.id&&i.intersects(t)){i.displace(t)}}),this.model.get("snapToGrid")){var i,n,a=Passage.width/2,s=Passage.height/2,o=t.get("left")%a;i=a/2>o?-o:a-o;var r=t.get("top")%s;n=s/2>r?-r:s-r,t.set({left:t.get("left")+i,top:t.get("top")+n})}},syncZoom:function(){var t=this.model.get("zoom");for(var e in this.ZOOM_MAPPINGS)if(this.ZOOM_MAPPINGS[e]==t){this.$el.removeClass("zoom-small zoom-medium zoom-big").addClass("zoom-"+e);break}},syncName:function(){document.title=window.app.say("Editing “%s”",this.model.get("name"))},updateSaved:function(){this.$(".saveIndicator").addClass("active fadeOut slow").one("animationend",function(){$(this).removeClass("active fadeOut")}),this.$(".storyName").attr("title",window.app.say("Last saved at %s",moment().format("llll"))),this.$(".storyName").powerTip()},events:{"drag .passage":function(t){this.linkManager.cachePassage(this.collection.get($(t.target).closest(".passage").attr("data-id"))),this.linkManager.drawLinks()},mousedown:function(t){this.lastMousedown=$(t.target)}}});StoryEditView.LinkManager=Backbone.View.extend({ARROW_ANGLE:Math.PI/6,ARROW_SIZE:10,initialize:function(t){this.parent=t.parent,this.svg=SVG(this.parent.$(".passages .content")[0]),this.passageCache={},this.lineCache={},this.listenTo(this.parent.collection,"change:name",function(t){delete this.passageCache[t.previous("name")]}).listenTo(this.parent.collection,"change",function(t){this.cachePassage(t),this.drawAll();var e=t.previous("name"),i=t.get("name");_.each(this.passageCache,function(t,n){(_.contains(t.links,e)||_.contains(t.links,i))&&this.parent.children.find(function(t){return t.model.get("name")==n?(t.render(),!0):void 0})},this)}).listenTo(this.parent.collection,"add",function(t){this.cachePassage(t),this.drawAll();var e=t.get("name");_.each(this.passageCache,function(t,i){_.contains(t.links,e)&&this.parent.children.find(function(t){return t.model.get("name")==i?(t.render(),!0):void 0})},this)}).listenTo(this.parent.collection,"remove",function(t){var e=t.get("name");delete this.passageCache[e],this.drawAll(),_.each(this.passageCache,function(t,i){_.contains(t.links,e)&&this.parent.children.find(function(t){return t.model.get("name")==i?(t.render(),!0):void 0})},this)}).listenTo(this.parent.model,"change:zoom",function(){_.defer(this.reset.bind(this))}),this.prepDragBound=this.prepDrag.bind(this),$("body").on("passagedragstart",this.prepDragBound),this.followDragBound=this.followDrag.bind(this),$("body").on("passagedrag",this.followDragBound),_.defer(this.reset.bind(this))},destroy:function(){$("body").off("passagedragstart",this.prepDragBound),$("body").off("passagedrag",this.followDragBound)},reset:function(){this.passageCache={},this.parent.collection.each(function(t){this.cachePassage(t)},this),this.drawAll()},drawAll:function(){var t=this.parent.model.get("zoom")>.25;this.svg.clear(),this.lineCache={};for(var e in this.passageCache)if(this.passageCache.hasOwnProperty(e))for(var i=this.passageCache[e].links,n=i.length-1;n>=0;n--){var a=i[n];this.drawConnector(e,a,t)}},drawConnector:function(t,e,i){var n=this.passageCache[t],a=this.passageCache[e];if(n&&a){var s,o=a.n[0]-n.n[0],r=a.n[1]-n.n[1],l=Math.abs(o/r);if(s=.8>l||l>1.3?Math.abs(o)>Math.abs(r)?o>0?[n.e,a.w]:[n.w,a.e]:r>0?[n.s,a.n]:[n.n,a.s]:0>o?0>r?[n.ne,a.sw]:[n.se,a.nw]:0>r?[n.nw,a.se]:[n.sw,a.ne],i){var c=this.endPointProjectedFrom(s,this.ARROW_ANGLE,this.ARROW_SIZE),h=this.endPointProjectedFrom(s,-this.ARROW_ANGLE,this.ARROW_SIZE);s.push(c,[s[1][0],s[1][1]],h)}this.lineCache[t]=this.lineCache[t]||{},this.lineCache[t][e]&&this.lineCache[t][e].remove(),this.lineCache[t][e]=this.svg.polyline(s)}},endPointProjectedFrom:function(t,e,i){var n=Math.sqrt(Math.pow(t[1][0]-t[0][0],2)+Math.pow(t[1][1]-t[0][1],2));if(0==n)return t[1];var a=i/n,s=t[1][0]-((t[1][0]-t[0][0])*Math.cos(e)-(t[1][1]-t[0][1])*Math.sin(e))*a,o=t[1][1]-((t[1][1]-t[0][1])*Math.cos(e)+(t[1][0]-t[0][0])*Math.sin(e))*a;return[s,o]},prepDrag:function(){this.drawArrowsWhileDragging=this.parent.model.get("zoom")>.25;this.parent.children.filter(function(t){return t.selected});this.draggedPassages=[];var t=[];this.parent.children.each(function(e){e.selected&&(this.draggedPassages.push(e.model),t.push(e.model.get("name")))},this),this.draggedConnectors=[],_.each(this.passageCache,function(e,i){for(var n=-1!=t.indexOf(i),a=e.links.length-1;a>=0;a--){var s=e.links[a];(n||-1!=t.indexOf(s))&&this.draggedConnectors.push([i,s])}},this)},followDrag:function(){for(var t=this.draggedPassages.length-1;t>=0;t--)this.cachePassage(this.draggedPassages[t]);for(t=this.draggedConnectors.length-1;t>=0;t--)this.drawConnector(this.draggedConnectors[t][0],this.draggedConnectors[t][1],this.drawArrowsWhileDragging)},cachePassage:function(t){var e=this.$(".passages").offset(),i=this.$('.passages div[data-id="'+t.id+'"] .frame'),n=i.offset(),a=i.outerWidth(),s=i.outerHeight();if(n){var o=n.left-e.left,r=n.top-e.top;this.passageCache[t.get("name")]={ne:[o,r],n:[o+a/2,r],nw:[o+a,r],se:[o,r+s],e:[o+a,r+s/2],w:[o,r+s/2],s:[o+a/2,r+s],sw:[o+a,r+s],links:t.links()}}}}),StoryEditView.Marquee=Backbone.View.extend({initialize:function(t){this.parent=t.parent,this.$marquee=this.$(".marquee"),this.followDragBound=this.followDrag.bind(this),this.endDragBound=this.endDrag.bind(this)},startDrag:function(t){if(!($(t.target).closest(".passage").length>0)){this.startX=t.pageX,this.startY=t.pageY,this.offset=this.$el.offset(),this.inclusive=t.shiftKey||t.ctrlKey;var e=this.$(".passage:first .frame").outerWidth(),i=this.$(".passage:first .frame").outerHeight();this.cache=[],this.parent.children.each(function(t){var n=t.$(".frame").offset();this.cache.push({view:t,left:n.left,top:n.top,right:n.left+e,bottom:n.top+i,originallySelected:t.selected}),this.inclusive||t.deselect()},this),$("#storyEditView").addClass("marqueeing"),$("body").on({mousemove:this.followDragBound,mouseup:this.endDragBound})}},followDrag:function(t){var e,i,n,a;t.pageX>this.startX?(e=this.startX,n=t.pageX-this.startX):(e=t.pageX,n=this.startX-t.pageX),t.pageY>this.startY?(i=this.startY,a=t.pageY-this.startY):(i=t.pageY,a=this.startY-t.pageY),this.$marquee.css({display:"block",left:e-this.offset.left,top:i-this.offset.top,width:n,height:a}),_.each(this.cache,function(t){this.inclusive&&t.originallySelected||(t.left<e+n&&t.right>e&&t.top<i+a&&t.bottom>i?t.view.select():t.view.deselect())},this)},endDrag:function(){this.$marquee.css("display","none"),$("#storyEditView").removeClass("marqueeing"),$("body").off({mousemove:this.followDragBound,mouseup:this.endDragBound})},events:{mousedown:"startDrag"}}),StoryEditView.Search=Backbone.View.extend({initialize:function(t){this.parent=t.parent,this.searchField=this.$(".searchField")},searchFor:function(t,e){t=new RegExp(t.replace(/([.*+?^${}()|\[\]\/\\])/g,"\\$1"),e||"i"),this.parent.children.each(function(e){e.model.matches(t)?e.highlight():e.unhighlight()})},clear:function(){this.searchField.val(""),this.$(".clearSearch").addClass("hide"),this.parent.children.each(function(t){t.unhighlight()})},events:{"keyup .searchField":_.debounce(function(t){27==t.keyCode&&this.searchField.val("");var e=this.searchField.val();""!=e?(this.$(".clearSearch").removeClass("hide"),this.searchFor(this.searchField.val())):this.clear()},100)}}),StoryEditView.Toolbar=Backbone.View.extend({initialize:function(t){this.parent=t.parent,this.syncZoomButtons(),this.syncStorySaved(),this.listenTo(this.parent.model,"change:zoom",this.syncZoomButtons),this.listenTo(this.parent.model,"change:name",this.syncStoryName),this.listenTo(this.parent.model,"update",this.syncStorySaved),this.listenTo(this.parent.collection,"update",this.syncStorySaved)},syncStoryName:function(){this.$(".storyNameVal").text(this.parent.model.get("name"))},syncZoomButtons:function(){var t=this.parent.model.get("zoom");for(var e in this.parent.ZOOM_MAPPINGS)if(this.parent.ZOOM_MAPPINGS[e]==t)var i="zoom"+e[0].toUpperCase()+e.substr(1);this.$(".zooms button").each(function(){var t=$(this);t.hasClass(i)?t.addClass("active"):t.removeClass("active")})},syncSnapToGrid:function(){var t=this.$(".snapToGrid").closest("li");this.parent.model.get("snapToGrid")?t.addClass("checked"):t.removeClass("checked")},syncStorySaved:function(t){var e=this.$(".storyName"),i=t?moment(t):moment();e.attr("title",window.app.say("Last saved at %s",i.format("llll"))),e.powerTip()},events:{"click .editScript":function(t){this.parent.scriptEditor.open()},"click .editStyle":function(t){this.parent.styleEditor.open()},"click .renameStory":function(t){this.parent.renameModal.open()},"click .addPassage":function(t){this.parent.addPassage()},"click .testStory":function(t){this.parent.test()},"click .playStory":function(t){this.parent.play()},"click .proofStory":function(t){this.parent.proof()},"click .publishStory":function(t){this.parent.publish()},"click .storyStats":function(t){this.parent.statsModal.open()},"click .changeFormat":function(t){this.parent.storyFormatModal.open()},"click .zoomBig, .zoomMedium, .zoomSmall":function(t){var e=$(t.target).closest("button").attr("class");e=e.replace(/^zoom/,"").replace(/ .*/,"").toLowerCase(),this.parent.model.save({zoom:this.parent.ZOOM_MAPPINGS[e]})},"click .snapToGrid":function(){this.parent.model.save({snapToGrid:!this.parent.model.get("snapToGrid")})},"bubbleshow .storyBubble":"syncSnapToGrid"}}),StoryEditView.ScriptEditor=Backbone.View.extend({initialize:function(t){this.parent=t.parent,this.scriptEditor=CodeMirror.fromTextArea(this.$(".scriptSource")[0],{lineWrapping:!0,lineNumbers:!1,tabSize:2,indentWithTabs:!0,mode:"javascript",extraKeys:{"Ctrl-Space":function(t){t.showHint()}}}),this.$(".scriptSource:first").data("codemirror",this.scriptEditor),this.$el.on({modalshown:function(){this.$el.one("animationend",function(){this.scriptEditor.refresh(),this.scriptEditor.focus()}.bind(this))}.bind(this),modalhide:function(){this.save()}.bind(this)})},open:function(){this.scriptEditor.doc.setValue(this.parent.model.get("script")),this.scriptEditor.refresh(),this.$el.data("modal").trigger("show")},close:function(){this.$el.data("modal").trigger("hide")},save:function(){this.parent.model.save({script:this.scriptEditor.doc.getValue()})}}),StoryEditView.StyleEditor=Backbone.View.extend({initialize:function(t){this.parent=t.parent,this.styleEditor=CodeMirror.fromTextArea(this.$(".stylesheetSource")[0],{lineWrapping:!0,lineNumbers:!1,tabSize:2,indentWithTabs:!0,mode:"css",extraKeys:{"Ctrl-Space":function(t){t.showHint()}}}),this.$(".stylesheetSource:first").data("codemirror",this.styleEditor),this.$el.on({modalshown:function(){this.$el.one("animationend",function(){this.styleEditor.refresh(),this.styleEditor.focus()}.bind(this))}.bind(this),modalhide:function(){this.save()}.bind(this)})},open:function(){this.styleEditor.doc.setValue(this.parent.model.get("stylesheet")),this.styleEditor.refresh(),this.$el.data("modal").trigger("show")},close:function(){this.$el.data("modal").trigger("hide")},save:function(){this.parent.model.save({stylesheet:this.styleEditor.doc.getValue()})}}),StoryEditView.PassageEditor=Backbone.View.extend({tagTemplate:'<span class="tag label label-info" data-name="<%- name %>"><%- name %><button class="remove"><i class="fa fa-times"></i></button></span>',initialize:function(t){this.tagContainer=this.$(".tags"),this.tagTemplate=_.template(this.tagTemplate),this.parent=t.parent,this.story=t.parent.model,this.cm=CodeMirror.fromTextArea(this.$(".passageText")[0],{prefixTrigger:{prefixes:["[[","->"],callback:this.autocomplete.bind(this)},extraKeys:{"Ctrl-Space":this.autocomplete.bind(this)},lineWrapping:!0,lineNumbers:!1,mode:"text"}),this.$el.on("modalhide",this.restoreTitle.bind(this)).on("modalshown",function(){this.$el.one("animationend",function(){this.cm.refresh(),this.cm.focus()}.bind(this))}.bind(this)).on("click",".showNewTag",this.showNewTag.bind(this)).on("click",".hideNewTag",this.hideNewTag.bind(this)).on("submit",function(t){var e=this.$(".newTagName").val().replace(/\s/g,"-");-1==this.model.get("tags").indexOf(e)&&this.addTag(e),this.hideNewTag(),t.preventDefault()}.bind(this)).on("click",".tag .remove",function(){$(this).closest(".tag").remove()}).data("blockModalHide",function(){var t=this.save();return t&&(window.onbeforeunload=null),!t}.bind(this))},open:function(){this.prevTitle=document.title,document.title=window.app.say("Editing “%s”",this.model.get("name")),this.$(".passageId").val(this.model.id),this.$(".passageName").val(this.model.get("name"));var t=this.story.get("storyFormat"),e=StoryFormat.withName(t);e&&e.load(function(e){var i=t.toLowerCase();!e&&i in CodeMirror.modes&&(CodeMirror.modes[i].cm=this.cm,this.cm.setOption("mode",i))}.bind(this)),this.cm.setOption("mode","text");var i=this.model.get("text");this.cm.setOption("placeholder",this.$(".passageText").attr("placeholder")),this.cm.swapDoc(CodeMirror.Doc("")),this.cm.setValue(i||""),this.cm.focus(),this.cm.clearHistory(),this.cm.execCommand(i==Passage.prototype.defaults.text?"selectAll":"goDocEnd"),this.tagContainer.empty(),_.each(this.model.get("tags"),this.addTag,this),this.cm.setOption("passageNames",_.map(this.parent.collection.models,function(t){return t.get("name")})),this.$el.data("modal").trigger("show"),this.cm.refresh(),window.onbeforeunload=function(){return window.app.say("Any changes to the passage you're editing haven't been saved yet. (To do so, close the passage editor.)")}},autocomplete:function(){this.cm.showHint({hint:function(t,e){var i=t.findWordAt(t.getCursor()),n=t.getRange(i.anchor,i.head).toLowerCase(),a={list:_.filter(t.getOption("passageNames"),function(t){return-1!=t.toLowerCase().indexOf(n)}),from:i.anchor,to:i.head};return CodeMirror.on(a,"pick",function(){var e=t.getDoc();e.replaceRange("]] ",e.getCursor())}),a},completeSingle:!1,extraKeys:{"]":function(t,e){var i=t.getDoc();i.replaceRange("]",i.getCursor()),e.close()},"-":function(t,e){var i=t.getDoc();i.replaceRange("-",i.getCursor()),e.close()},"|":function(t,e){var i=t.getDoc();i.replaceRange("|",i.getCursor()),e.close()}}})},close:function(){this.$el.data("modal").trigger("hide")},save:function(){var t=[];if(this.$(".passageTags .tag").each(function(){t.push($(this).attr("data-name"))}),this.model.save({name:this.$(".passageName").val(),text:this.cm.doc.getValue(),tags:t}))return this.$(".error").addClass("hide").hide(),this.$el.removeClass("hasError"),!0;var e=this.$(".error");return e.removeClass("hide").text(this.model.validationError).hide().fadeIn(),this.$el.addClass("hasError"),this.$(".passageName").focus(),!1},showNewTag:function(){this.$(".showNewTag").hide(),this.$(".newTag").show(),this.$(".newTagName").val("").focus()},hideNewTag:function(){this.$(".showNewTag").show(),this.$(".newTag").hide()},addTag:function(t){this.tagContainer.append(this.tagTemplate({name:t}))},restoreTitle:function(){document.title=this.prevTitle}}),StoryEditView.RenameStoryModal=Backbone.View.extend({initialize:function(t){this.parent=t.parent},open:function(){this.$(".storyName").val(this.parent.model.get("name")),this.$(".noNameError").hide(),this.$el.data("modal").trigger("show"),this.$(".storyName").focus()},close:function(){this.$el.data("modal").trigger("hide")},save:function(t){t.stopImmediatePropagation();var e=this.$(".storyName").val();return""==e.trim()?void this.$(".noNameError").show().fadeIn():(this.parent.model.save({name:this.$(".storyName").val()}),void this.close())},events:{"submit #renameStoryForm":"save"}}),StoryEditView.SearchModal=Backbone.View.extend({initialize:function(t){this.parent=t.parent,this.resultTemplate=_.template($(".searchModalResult").html())},open:function(){this.$el.data("modal").trigger("show")},close:function(){this.$el.data("modal").trigger("hide")},updateResults:function(){var t=this.searchRegexp(),e=this.$("#searchNames").prop("checked");if(""==t.source)return this.$(".results").empty(),void this.$(".resultSummary").hide();var i=0,n="";this.$(".loading").show(),this.parent.children.each(function(a){var s=a.model.numMatches(t,e);if(0!=s){i++;var o=_.escape(a.model.get("name"));e&&(o=o.replace(t,'<span class="highlight">$1</span>'));var r=_.escape(a.model.get("text").replace(t,"　$1、"));r=r.replace(/\u3000/g,'<span class="highlight">'),r=r.replace(/\u3001/g,"</span>","g"),n+=this.resultTemplate(_.extend({passageId:a.model.cid,passageName:o,numMatches:s,resultNumber:i,searchPreview:r},window.app.templateProperties))}}.bind(this)),this.$(".loading").hide(),""!=n?(this.$(".matches").text(window.app.sayPlural("%d passage matches.","%d passages match.",i)),this.$(".resultSummary").show(),this.$(".results").html(n)):(this.$(".resultSummary").hide(),this.$(".results").html("<p>"+window.app.say("No matching passages found.")+"</p>"))},showAllResults:function(){this.$(".results").find(".collapseContainer").each(function(){$(this).collapse("show")})},hideAllResults:function(){this.$(".results").find(".collapseContainer").each(function(){$(this).collapse("hide")})},replaceInPassage:function(t){var e=$(t.target).closest(".result"),i=this.parent.children.findByModelCid(e.attr("data-passage")).model;i.replace(this.searchRegexp(),this.$("#replaceWith").val(),this.$("#searchNames").prop("checked")),e.slideUp(null,function(){e.remove()})},replaceAll:function(){{var t=0,e=0,i=this.searchRegexp(),n=this.$("#replaceWith").val();this.$("#searchNames").prop("checked")}this.parent.children.each(function(a){var s=a.model.numMatches(i);0!=s&&(t++,e+=s,a.model.replace(i,n,this.$("#searchNames").prop("checked")))}.bind(this)),this.$el.one("modalhide",function(){var i=window.app.sayPlural("%d replacement was made in","%d replacements were made in",e),n=window.app.sayPlural("%d passage","%d passages",t);ui.notify(window.say("%1$s %2$s",i,n))}),this.close()},searchRegexp:function(){var t="g";this.$("#searchCaseSensitive").prop("checked")||(t+="i");var e=this.$("#searchFor").val();return this.$("#searchRegexp").prop("checked")&&(e=e.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&")),new RegExp("("+e+")",t)},syncSearch:function(){this.$(".results").empty(),this.$(".resultSummary").hide(),this.$("#searchFor").val($("#storyEditView .searchField").val())},events:{modalshow:"syncSearch","keyup #searchFor":"updateResults","change #searchNames":"updateResults","change #searchCaseSensitive":"updateResults","change #searchRegexp":"updateResults","click .expandAll":"showAllResults","click .collapseAll":"hideAllResults","click .replacePassage":"replaceInPassage","click .replaceAll":"replaceAll"}}),StoryEditView.StatsModal=Backbone.View.extend({initialize:function(t){this.parent=t.parent},open:function(){var t=0,e=0,i=0,n=0,a=0,s={},o=[];_.each(this.parent.collection.models,function(a){i++;var r=a.get("text");t+=r.length,e+=r.split(/\s+/).length;var l=a.links();n+=l.length,o.push(a.get("name")),_.each(l,function(t){s[t]=(s[t]||0)+1})}),_.each(s,function(t,e){-1==o.indexOf(e)&&(a+=t)}),this.$(".charCount").text(t.toLocaleString()),this.$(".wordCount").text(e.toLocaleString()),this.$(".passageCount").text(i.toLocaleString()),this.$(".linkCount").text(n.toLocaleString()),this.$(".brokenLinkCount").text(a.toLocaleString()),this.$(".charDesc").text(window.app.sayPlural("Character","Characters",t)),this.$(".wordDesc").text(window.app.sayPlural("Word","Words",e)),this.$(".passageDesc").text(window.app.sayPlural("Passage","Passages",i)),this.$(".linkDesc").text(window.app.sayPlural("Link","Links",i)),this.$(".brokenLinkDesc").text(window.app.sayPlural("Broken Link","Broken Links",i)),this.$el.data("modal").trigger("show")},close:function(){this.$el.data("modal").trigger("hide")}}),StoryEditView.StoryFormatModal=Backbone.View.extend({initialize:function(t){this.parent=t.parent,this.itemTemplate=_.template($(".singleStoryFormatItem").html())},open:function(){this.$(".formats").empty(),this.formatsToLoad=StoryFormatCollection.all(),this.loadNextFormat(),this.$el.data("modal").trigger("show")},close:function(){this.$el.data("modal").trigger("hide")},changeFormat:function(t){this.parent.model.save({storyFormat:t}),this.$(".detail button.select").each(function(){var e=$(this);e.closest(".detail").data("format")==t?e.addClass("active"):e.removeClass("active")})},loadNextFormat:function(){if(this.formatsToLoad.length>0){var t=this.formatsToLoad.at(0);t.load(function(e){if(void 0===e){if(!t.properties.proofing){var i=t.get("url").replace(/\/[^\/]*?$/,""),n=_.extend(t.properties,{path:i},window.app.templateProperties),a=$(this.itemTemplate(n));this.$(".formats").append(a),n.name==this.parent.model.get("storyFormat")&&a.find("button.select").addClass("active")}}else ui.notify(window.app.say("The story format &ldquo;%1$s&rdquo; could not be loaded (%2$s).",t.get("name"),e.message),"danger");this.formatsToLoad.remove(t),this.loadNextFormat()}.bind(this))}else this.$(".loading").hide()},events:{"click button.select":function(t){this.changeFormat($(t.target).closest("button").data("format"))}}});var TwineRouter=Backbone.Router.extend({welcome:function(){window.app.mainRegion.show(new WelcomeView)},locale:function(){window.app.mainRegion.show(new LocaleView)},listStories:function(){window.app.mainRegion.show(new StoryListView({collection:StoryCollection.all()}))},editStory:function(t){window.app.mainRegion.show(new StoryEditView({model:Story.withId(t)}))},playStory:function(t){window.app.publishStory(Story.withId(t))},testStory:function(t,e){
window.app.publishStory(Story.withId(t),null,{formatOptions:["debug"],startPassageId:e})},proofStory:function(t){var e=Story.withId(t),i=StoryFormat.withName(AppPref.withName("proofingFormat").get("value"));window.app.publishStory(e,null,{format:i})},startup:function(){var t=AppPref.withName("welcomeSeen",!1);window.location.hash=t.get("value")===!0?"#stories":"#welcome"},routes:{welcome:"welcome",locale:"locale",stories:"listStories","stories/:id":"editStory","stories/:id/play":"playStory","stories/:id/test":"testStory","stories/:storyId/test/:passageId":"testStory","stories/:id/proof":"proofStory","*path":"startup"}}),TransRegion=Backbone.Marionette.Region.extend({initialize:function(){this.on("before:swapOut",function(t){this.prevView=t,t instanceof StoryEditView&&(this.prevId=t.model.get("id"))}.bind(this)),this.on("swap",function(t){t instanceof StoryListView&&this.prevView instanceof StoryEditView&&(t.appearFast=!0,t.previouslyEditing=this.prevId)}.bind(this))}}),TwineApp=Backbone.Marionette.Application.extend({name:"Twine",version:"2.0.7",loadLocale:function(t,e){this.locale=t,moment.locale(t),"en-us"!=t&&"en"!=t?$.ajax({url:"locale/"+t+".js",dataType:"jsonp",jsonpCallback:"locale",crossDomain:!0}).always(function(t){this.i18nData=t,e()}.bind(this)):(this.i18nData={domain:"messages",locale_data:{messages:{"":{domain:"messages",lang:"en-us",plural_forms:"nplurals=2; plural=(n != 1);"}}}},e())},say:function(t){try{if(1==arguments.length)return this.i18n.gettext(t);for(var e=[this.i18n.gettext(t)],i=1;i<arguments.length;i++)e.push(arguments[i]);return this.i18n.sprintf.apply(this.i18n.sprintf,e)}catch(n){return t}},sayPlural:function(t,e,i){try{for(var n=[this.i18n.ngettext(t,e,i),i],a=3;a<arguments.length;a++)n.push(arguments[a]);return this.i18n.sprintf.apply(this.i18n.sprintf,n)}catch(s){return e.replace(/%d/g,i)}},saveFile:function(t,e,i,n){try{var a=$("body");if(a.hasClass("iOS")){var s=new JSZip;s.file(e,t),window.location.href="data:application/zip;base64, "+s.generate({type:"base64"}),i&&i()}else{var o=new Blob([t],{type:"text/html;charset=utf-8"});a.hasClass("safari")?window.location.href=URL.createObjectURL(o):saveAs(o,e),i&&i()}}catch(r){n?n(r):ui.notify(this.say("&ldquo;%1$s&rdquo; could not be saved (%2$s).",e,r.message),"danger")}},replaceContent:function(t){window.ui.uninitBody(),$("head").html(t.substring(t.indexOf("<head>")+6,t.indexOf("</head>"))),$("body").html(t.substring(t.indexOf("<body>")+6,t.indexOf("</body>")))},publishStory:function(t,e,i){i=i||{};var n;if(i.format)n=i.format;else{var a=i.format||t.get("storyFormat")||AppPref.withName("defaultFormat").get("value");n=StoryFormat.withName(a)}n.publish(t,i.formatOptions,i.startPassageId,function(t,i){t?ui.notify(this.say("An error occurred while publishing your story. (%s)",t.message),"danger"):e?this.saveFile(i,e):this.replaceContent(i)}.bind(this))},saveArchive:function(){var t="";StoryCollection.all().each(function(e){t+=e.publish(null,null,!0)+"\n\n"}),this.saveFile(t,(new Date).toLocaleString().replace(/[\/:\\]/g,".")+" "+window.app.say("Twine Archive.html"))},importFile:function(t,e){var i=this.selectors,n=new StoryCollection,a=new PassageCollection,s=0,o=document.createElement("div");return o.innerHTML=t,_.each(o.querySelectorAll(i.storyData),function(t){var o=t.attributes.startnode.value,r="";_.each(t.querySelectorAll(i.stylesheet),function(t){r+=t.innerHTML+"\n"});var l="";_.each(t.querySelectorAll(i.script),function(t){l+=t.innerHTML+"\n"});var c=n.create({name:t.attributes.name.value,storyFormat:t.attributes.format.value,ifid:t.attributes.ifid.value,stylesheet:""!==r?r:null,script:""!==l?l:null},{wait:!0,silent:!0,validate:!1});_.each(t.querySelectorAll(i.passageData),function(t){var e=t.attributes.pid.value,i=t.attributes.position.value,n=i.split(","),s=t.attributes.tags.value;s=""===s?[]:s.split(/\s+/);var r=a.create({name:t.attributes.name.value,tags:s,text:t.innerHTML,story:c.id,left:parseInt(n[0]),top:parseInt(n[1])},{wait:!0,silent:!0,validate:!1});e==o&&c.save({startPassage:r.id},{silent:!0,validate:!1})}),e&&c.save({lastUpdate:e},{silent:!0,validate:!1}),s++}),s},checkForUpdate:function(t,e){$.getJSON("http://twinery.org/latestversion/2.json",function(i){i.buildNumber>t&&e(i)})},hasPrimaryTouchUI:function(){return/Android|iPod|iPad|iPhone|IEMobile/.test(window.navigator.userAgent)},selectors:{passage:"tw-passage",story:"tw-story",script:"[role=script]",stylesheet:"[role=stylesheet]",storyData:"tw-storydata",passageData:"tw-passagedata"}});window.app=new TwineApp,window.app.addInitializer(function(){this.i18n=new Jed(this.i18nData),nwui.active&&nwui.init(),this.templateProperties={s:this.say.bind(this),sp:this.sayPlural.bind(this)},Backbone.Marionette.Renderer.render=function(t,e){return t=Marionette.TemplateCache.get(t),e=_.extend(e,window.app.templateProperties),"function"==typeof t?t(e):_.template(t)(e)},window.app.buildNumber=parseInt($("html").data("build-number")),window.app.router=new TwineRouter,Backbone.history.start();var t=StoryFormatCollection.all();t.findWhere({name:"Harlowe"})||t.create({name:"Harlowe",url:"storyformats/Harlowe/format.js",userAdded:!1}),t.findWhere({name:"Snowman"})||t.create({name:"Snowman",url:"storyformats/Snowman/format.js",userAdded:!1}),t.findWhere({name:"Paperthin"})||t.create({name:"Paperthin",url:"storyformats/Paperthin/format.js",userAdded:!1}),t.findWhere({name:"SugarCube"})||t.create({name:"SugarCube",url:"http://www.motoslave.net/sugarcube/1/twine2/format.js",userAdded:!1}),AppPref.withName("defaultFormat","Harlowe"),AppPref.withName("proofingFormat","Paperthin")}),window.app.addRegions({mainRegion:{selector:"#regions .main",regionClass:TransRegion}}),function(){var t,e=/locale=([^&]+)&?/.exec(window.location.search);if(e)t=e[1];else{var i=AppPref.withName("locale",window.navigator.userLanguage||window.navigator.language||window.navigator.browserLanguage||window.navigator.systemLanguage||"en-us");t=i.get("value")}"string"==typeof t?window.app.loadLocale(t.toLowerCase(),function(){window.app.start()}):window.app.loadLocale("en",function(){window.app.start(),_.defer(function(){ui.notify("Your locale preference has been reset to English due to a technical problem.<br>Please change it with the <b>Language</b> option in the story list.","danger")})})}();